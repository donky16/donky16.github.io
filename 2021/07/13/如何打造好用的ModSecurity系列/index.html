<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans,en,default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="WAF,ModSecurity," />










<meta name="description" content="文章首发于奇安信攻防社区，链接https://forum.butian.net/share/258，原文有三部分，此处为完整版">
<meta name="keywords" content="WAF,ModSecurity">
<meta property="og:type" content="article">
<meta property="og:title" content="如何打造好用的ModSecurity系列">
<meta property="og:url" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/index.html">
<meta property="og:site_name" content="donky16">
<meta property="og:description" content="文章首发于奇安信攻防社区，链接https://forum.butian.net/share/258，原文有三部分，此处为完整版">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210603121958750.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210603143948655.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210719155312757.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210719161434585.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210719162403980.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210719170355478.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210720180650475.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210720180727980.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210719173328574.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210719174055580.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210719181809958.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210719181747271.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210720173625351.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210720173828868.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210720182136187.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210720182211229.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210827143140621.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210827154633740.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210827154937977.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210827161434572.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210827161628439.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210827161859982.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210827163252780.png">
<meta property="og:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210827163702220.png">
<meta property="og:updated_time" content="2022-03-28T12:22:08.798Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何打造好用的ModSecurity系列">
<meta name="twitter:description" content="文章首发于奇安信攻防社区，链接https://forum.butian.net/share/258，原文有三部分，此处为完整版">
<meta name="twitter:image" content="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/image-20210603121958750.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/"/>





  <title>如何打造好用的ModSecurity系列 | donky16</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">donky16</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://donky.cn/2021/07/13/如何打造好用的ModSecurity系列/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="donky16">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="donky16">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">如何打造好用的ModSecurity系列</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-13T19:34:47+08:00">
                2021-07-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WAF/" itemprop="url" rel="index">
                    <span itemprop="name">WAF</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>文章首发于奇安信攻防社区，链接<a href="https://forum.butian.net/share/258" target="_blank" rel="noopener">https://forum.butian.net/share/258</a>，原文有三部分，此处为完整版<a id="more"></a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h3><p>ModSecurity 是一个 Web 应用程序防火墙 (WAF)，并且具有一个强大的持续维护的规则库，其有以下优点。</p>
<ul>
<li><p>实时监控和攻击检测</p>
<p>实时监控 HTTP 流量以检测攻击，并且提供可自定义的日志记录功能。</p>
</li>
<li><p>预防攻击和虚拟补丁</p>
<p>可以拦截利用已知漏洞进行的攻击，并且可以打虚拟补丁，对于一些异常的行为可以对其ip等进行打分行为，从而跟踪行为，最终判定是否拦截。</p>
</li>
<li><p>灵活的规则引擎</p>
<p>CRS(coreruleset)是ModSecurity体系的核心，规则体系强大并且灵活，下文也将重点介绍其规则体系。</p>
</li>
<li><p>嵌入式模式部署</p>
<p>ModSecurity 是一个嵌入式 Web 应用程序防火墙，这样可以缩小性能开销，并且对于https流量也能直接处理。</p>
</li>
<li><p>基于网络的部署</p>
<p>可以部署在反向代理服务器上，用于保护后端服务。</p>
</li>
<li><p>可移植性</p>
<p>能够用在各种操作系统上。</p>
</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装环境：Ubuntu18.04</p>
<h3 id="1-1-Libmodsecurity"><a href="#1-1-Libmodsecurity" class="headerlink" title="1.1 Libmodsecurity"></a>1.1 Libmodsecurity</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt-get install g++ flex bison curl doxygen libyajl-dev libgeoip-dev libtool dh-autoreconf libcurl4-gnutls-dev libxml2 libpcre++-dev libxml2-dev</span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/SpiderLabs/ModSecurity</span><br><span class="line"><span class="built_in">cd</span> ModSecurity/</span><br><span class="line">git checkout -b v3/master origin/v3/master</span><br><span class="line">sh build.sh</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update <span class="comment">#[for bindings/python, others/libinjection, test/test-cases/secrules-language-tests]</span></span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>include/lib文件位置：/usr/local/modsecurity</p>
<p><img src="image-20210603121958750.png" alt="image-20210603121958750"> </p>
<h3 id="1-2-Nginx-modsecurity"><a href="#1-2-Nginx-modsecurity" class="headerlink" title="1.2 Nginx-modsecurity"></a>1.2 Nginx-modsecurity</h3><p>安装带有modsec模块的Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.20.1.tar.gz</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/SpiderLabs/ModSecurity-nginx.git</span><br><span class="line">tar -zxvf nginx-1.20.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.20.1/</span><br><span class="line">./configure --add-module=/root/modsecurity-nginx/ --prefix=/usr/<span class="built_in">local</span>/nginx </span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -t	<span class="comment"># test</span></span><br></pre></td></tr></table></figure>
<p>添加规则并配置Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/coreruleset/coreruleset/</span><br><span class="line"><span class="built_in">cd</span> coreruleset/</span><br><span class="line">cp crs-setup.conf.example crs-setup.conf</span><br><span class="line">cp /root/ModSecurity/modsecurity.conf-recommended /usr/<span class="built_in">local</span>/nginx/conf/modsecurity.conf</span><br></pre></td></tr></table></figure>
<p>修改modsecurity.conf令其加载crs，增加两行</p>
<blockquote>
<p>Include /root/coreruleset/crs-setup.conf </p>
<p>Include /root/coreruleset/rules/*.conf</p>
</blockquote>
<p>需要直接进行拦截的话，修改SecRuleEngine</p>
<blockquote>
<p>SecRuleEngine On</p>
</blockquote>
<p>修改/usr/local/nginx/conf/nginx.con，使Nginx加载modsec并指定配置文件</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">modsecurity</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">1001</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">modsecurity_rules_file</span> /usr/local/nginx/conf/modsecurity.conf;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<p>发现报错</p>
<blockquote>
<p>nginx: [emerg] “modsecurity_rules_file” directive Rules error. File: /usr/local/nginx/conf/modsecurity.conf. Line: 236. Column: 17. Failed to locate the unicode map file from: unicode.mapping Looking at: ‘unicode.mapping’, ‘unicode.mapping’, ‘/usr/local/nginx/conf/unicode.mapping’, ‘/usr/local/nginx/conf/unicode.mapping’.  in /usr/local/nginx/conf/nginx.conf:45</p>
</blockquote>
<p><a href="https://github.com/SpiderLabs/ModSecurity/issues/1941" target="_blank" rel="noopener">解决方案</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /root/ModSecurity/unicode.mapping /usr/<span class="built_in">local</span>/nginx/conf/</span><br></pre></td></tr></table></figure>
<h3 id="1-3-Apache2-modsecurity"><a href="#1-3-Apache2-modsecurity" class="headerlink" title="1.3 Apache2-modsecurity"></a>1.3 Apache2-modsecurity</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install apache2</span><br><span class="line">apt-get install libapache2-mod-security2</span><br></pre></td></tr></table></figure>
<p>apache2配置文件</p>
<blockquote>
<p>/etc/apache2/mods-enabled/security2.load    #加载库</p>
<p>/etc/apache2/mods-enabled/security2.conf</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">security2_module</span>&gt;</span></span><br><span class="line">        # Default Debian dir for modsecurity's persistent data</span><br><span class="line">        SecDataDir /var/cache/modsecurity</span><br><span class="line"></span><br><span class="line">        # Include all the *.conf files in /etc/modsecurity.</span><br><span class="line">        # Keeping your local configuration in that directory</span><br><span class="line">        # will allow for an easy upgrade of THIS file and</span><br><span class="line">        # make your life easier</span><br><span class="line">        IncludeOptional /etc/modsecurity/*.conf		#加载modsec中配置文件</span><br><span class="line"></span><br><span class="line">        # Include OWASP ModSecurity CRS rules if installed</span><br><span class="line">        IncludeOptional /usr/share/modsecurity-crs/owasp-crs.load	#加载规则</span><br><span class="line"><span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>modsec位置</p>
<blockquote>
<p>/etc/modsecurity</p>
</blockquote>
<p><img src="image-20210603143948655.png" alt="image-20210603143948655"> </p>
<p>crs位置</p>
<blockquote>
<p>/usr/share/modsecurity-crs</p>
</blockquote>
<p>启动apache即可开启modsec</p>
<p>如果安装最新crs，需要按照上面步骤下载，在/etc/apache2/mods-enabled/security2.conf中修改规则位置</p>
<blockquote>
<p>IncludeOptional /root/coreruleset/*.conf</p>
<p>IncludeOptional /root/coreruleset/rules/*.conf</p>
</blockquote>
<p>重启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart apache2</span><br></pre></td></tr></table></figure>
<h3 id="2-测试拦截"><a href="#2-测试拦截" class="headerlink" title="2. 测试拦截"></a>2. 测试拦截</h3><p>测试post_body:  a=/bin/bash</p>
<h4 id="2-1-nginx-log"><a href="#2-1-nginx-log" class="headerlink" title="2.1 nginx log"></a>2.1 nginx log</h4><p>/usr/local/nginx/logs/error.log</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">2021/06/03 15:50:25 [error] 29019#0: *13 </span><br><span class="line">[client 220.181.55.132] </span><br><span class="line">ModSecurity: Access denied with code 403 (phase 2). </span><br><span class="line">Matched "Operator `Ge' with parameter `5' against variable `TX:ANOMALY_SCORE' (Value: `8' ) </span><br><span class="line">[file "/root/coreruleset/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] </span><br><span class="line">[line "138"] </span><br><span class="line">[id "949110"]</span><br><span class="line">[rev ""] </span><br><span class="line">[msg "Inbound Anomaly Score Exceeded (Total Score: 8)"] </span><br><span class="line">[data ""] </span><br><span class="line">[severity "2"] </span><br><span class="line">[ver "OWASP_CRS/4.0-dev"] </span><br><span class="line">[maturity "0"] </span><br><span class="line">[accuracy "0"] </span><br><span class="line">[tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"] [hostname "192.168.1.59"] </span><br><span class="line">[uri "/"] </span><br><span class="line">[unique_id "1622706625"] </span><br><span class="line">[ref ""], </span><br><span class="line">client: 220.181.55.132, </span><br><span class="line">server: localhost, </span><br><span class="line">request: "POST / HTTP/1.1", </span><br><span class="line">host: "39.107.124.151:1001"</span><br></pre></td></tr></table></figure>
<p>其他modsec详细分析日志，默认放在/var/log/modsec_audit.log</p>
<h4 id="2-2-apache2-log"><a href="#2-2-apache2-log" class="headerlink" title="2.2 apache2 log"></a>2.2 apache2 log</h4><p>使用coreruleset规则</p>
<p>/etc/log/apache2/error.log</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Thu Jun 03 16:02:02.896289 2021] [:error] [pid 32696] </span><br><span class="line">[client 220.181.55.132:37233] [client 220.181.55.132] </span><br><span class="line">ModSecurity: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. </span><br><span class="line">[file "/root/coreruleset/rules/REQUEST-949-BLOCKING-EVALUATION.conf"] </span><br><span class="line">[line "150"] </span><br><span class="line">[id "949110"] </span><br><span class="line">[msg "Inbound Anomaly Score Exceeded (Total Score: 8)"] </span><br><span class="line">[severity "CRITICAL"] </span><br><span class="line">[ver "OWASP_CRS/4.0-dev"] [tag "application-multi"] [tag "language-multi"] [tag "platform-multi"] [tag "attack-generic"] </span><br><span class="line">[hostname "39.107.124.151"] </span><br><span class="line">[uri "/"] </span><br><span class="line">[unique_id "YLiMetbycvfIaMD669H-hwAAAAA"]</span><br></pre></td></tr></table></figure>
<h2 id="引擎规则体系"><a href="#引擎规则体系" class="headerlink" title="引擎规则体系"></a>引擎规则体系</h2><h3 id="3-1-规则引擎配置"><a href="#3-1-规则引擎配置" class="headerlink" title="3.1 规则引擎配置"></a>3.1 规则引擎配置</h3><p>规则引擎的配置文件位于modsecurity.conf文件中，主要控制waf引擎的行为，下面介绍一些重要的参数</p>
<ol>
<li><p>SecRuleEngine：On/Off/Detection Only分别代表开启或关闭waf，和只检测但不进行任何阻断操作</p>
</li>
<li><p>SecRequestBodyAccess：是否允许waf检测request body，一般都会打开</p>
</li>
<li><p>request body格式解析：目前modsecurity额外支持xml、json、multipart的解析</p>
<p>Content-Type为<code>(?:application(?:/soap\+|/)|text/)xml</code>的使用xml解析引擎，<code>application/json</code>的使用json解析引擎</p>
<p>并设置了<code>REQBODY_ERROR</code>参数用于在解析request body过程中出现错误的记录，对于multipart格式，专门设置了<code>MULTIPART_STRICT_ERROR</code>参数，并根据错误类型进行严格的记录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PE %&#123;REQBODY_PROCESSOR_ERROR&#125;, \</span><br><span class="line">BQ %&#123;MULTIPART_BOUNDARY_QUOTED&#125;, \</span><br><span class="line">BW %&#123;MULTIPART_BOUNDARY_WHITESPACE&#125;, \</span><br><span class="line">DB %&#123;MULTIPART_DATA_BEFORE&#125;, \</span><br><span class="line">DA %&#123;MULTIPART_DATA_AFTER&#125;, \</span><br><span class="line">HF %&#123;MULTIPART_HEADER_FOLDING&#125;, \</span><br><span class="line">LF %&#123;MULTIPART_LF_LINE&#125;, \</span><br><span class="line">SM %&#123;MULTIPART_MISSING_SEMICOLON&#125;, \</span><br><span class="line">IQ %&#123;MULTIPART_INVALID_QUOTING&#125;, \</span><br><span class="line">IP %&#123;MULTIPART_INVALID_PART&#125;, \</span><br><span class="line">IH %&#123;MULTIPART_INVALID_HEADER_FOLDING&#125;, \</span><br><span class="line">FL %&#123;MULTIPART_FILE_LIMIT_EXCEEDED&#125;</span><br></pre></td></tr></table></figure>
<p>modsecurity对于multipart解析进行了严格的格式校验，也就是说一般的绕过waf的方式，可能会因为格式校验不通过而失败，具体在multipart解析层面对waf的绕过可以参考<a href="https://www.anquanke.com/post/id/241265" target="_blank" rel="noopener">从RFC看如何绕过waf文件上传表单</a>，简单测试一下在boundary处的绕过waf的小trick</p>
<p><img src="image-20210719155312757.png" alt="image-20210719155312757"></p>
<p>直接400了，查看nginx日志能看到详细信息</p>
<p><img src="image-20210719161434585.png" alt="image-20210719161434585"></p>
<p><code>BQ MULTIPART_BOUNDARY_QUOTED</code>为1，格式校验失败，当然这种严格的格式校验有误报的可能性，但也相对来说增加了绕过waf的难度。</p>
</li>
<li><p>SecResponseBodyAccess：是否允许waf检测响应包response body</p>
</li>
<li><p>SecDebugLogLevel：调试日志级别，不建议设置太高，增加性能消耗</p>
<p><img src="image-20210719162403980.png" alt="image-20210719162403980"> </p>
</li>
<li><p>SecAuditEngine/SecAuditLogRelevantStatus 仅为状态代码与提供的正则表达式匹配的事务配置审计日志记录。默认将记录所有 5xx 和 4xx 级别的状态代码，404 除外。</p>
</li>
<li><p>SecAuditLogParts： 每个事务中记录到审计日志中的部分，默认ABIJDEFHZ，具体取值可参考</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">A：审计日志头（必须配置）</span><br><span class="line">B：请求头</span><br><span class="line">C：请求体（仅在请求体存在并且ModSecurity配置为拦截它时才存在。 这需要将SecRequestBodyAccess设置为On）</span><br><span class="line">D：该值是为中间响应头保留，尚未有任何实际作用</span><br><span class="line">E：中间响应体（仅当ModSecurity配置为拦截响应体并且审计日志引擎配置为记录时才存在。 拦截响应体需要将SecResponseBodyAccess设置为On）。 除非ModSecurity拦截中间响应体，否则中间响应体与实际响应体相同，在这种情况下，实际响应体将包含错误消息（Apache默认错误消息或ErrorDocument页面））</span><br><span class="line">F：最终响应头（不包括日期和服务器标题，Apache始终在内容交付的后期阶段添加）</span><br><span class="line">G：该值是为实际响应体保留，尚未有任何实际作用</span><br><span class="line">H：审计日志追踪内容；</span><br><span class="line">I：该部分是C的替代品。除了使用multipart/form-data编码，否则它在所有情况下记录的数据与C相同。 在这种情况下，它将记录一个假应用程序/ x-www-form-urlencoded正文，其中包含有关参数的信息，但不包含有关文件的信息。 如果您不想在审核日志中存储（通常很大）的文件，使用I比使用C更方便。</span><br><span class="line">J：该部分包含有关使用multipart/form-data编码上传的文件的信息。</span><br><span class="line">K：该部分包含了本次访问中所匹配到的所有规则（按每行一个进行记录）。规则是完全合格的，因此将显示继承的操作和默认操作符。V2.5.0以上支持。</span><br><span class="line">Z：结尾分界线，表示本次日志记录完毕（必须配置）</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="3-2-规则体系解析"><a href="#3-2-规则体系解析" class="headerlink" title="3.2 规则体系解析"></a>3.2 规则体系解析</h3><h4 id="3-2-1-ModSecurity事务生命周期"><a href="#3-2-1-ModSecurity事务生命周期" class="headerlink" title="3.2.1 ModSecurity事务生命周期"></a>3.2.1 ModSecurity事务生命周期</h4><p>每个事务在modsecurity需要经历5个阶段，在每个阶段可能需要解析等操作，然后调用相应阶段的规则进行匹配，对应规则中的<code>phase</code></p>
<p><img src="image-20210719170355478.png" alt="image-20210719170355478"> </p>
<p>阶段一：request headers请求头，这是modsecurity最先接触到的数据，需要验证请求头相关的规则，并根据请求头来判断如何解析request body</p>
<p>阶段二：request body请求体，此阶段需要根据请求头正确解析body数据，并验证request body相关的规则</p>
<p>阶段三：response headers响应头，在获取到响应头之后，验证response header相关的规则</p>
<p>阶段四：response body响应体，正确解析响应体数据之后，验证response body相关的规则</p>
<p>阶段五：logging日志记录，日志记录阶段是一定存在的，用于记录事务信息，包括命中规则信息，处理方式等。</p>
<h4 id="3-2-2-ModSecurity全局规则配置级别"><a href="#3-2-2-ModSecurity全局规则配置级别" class="headerlink" title="3.2.2 ModSecurity全局规则配置级别"></a>3.2.2 ModSecurity全局规则配置级别</h4><p>modsecurity根据规则可能存在的误报情况，设置了规则的级别，称之为PL(paranoia level)，共有4个级别，分别为1/2/3/4，级别越高，漏报越少，误报越多。用户可以根据实际业务情况适当调整，默认设置PL=1，可以在crs-setup.conf中设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SecAction \</span><br><span class="line">  &quot;id:900000,\</span><br><span class="line">   phase:1,\</span><br><span class="line">   nolog,\</span><br><span class="line">   pass,\</span><br><span class="line">   t:none,\</span><br><span class="line">   setvar:tx.paranoia_level=1&quot;</span><br></pre></td></tr></table></figure>
<p>其规则的分级方式也很特别，是通过在规则文件中的位置进行的分级，下面简化下分级规则设置方法</p>
<ul>
<li><p>级别规则设置方法：skipAfter和SecMarker</p>
<p>skipAfter：条件达成，跳到下个标记点</p>
<p>SecMarker：规则标记点</p>
</li>
<li><p>规则结构</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">SecRule</span> <span class="attr">TX:EXECUTING_PARANOIA_LEVEL</span> <span class="string">"@lt 1"</span> <span class="string">"id:920011,phase:1,pass,nolog,skipAfter:END-REQUEST-920-PROTOCOL-ENFORCEMENT"</span>	<span class="comment"># PL&lt;1，跳到SecMarker，全部规则无法应用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#一级规则</span></span><br><span class="line"></span><br><span class="line"><span class="string">SecRule</span> <span class="attr">TX:EXECUTING_PARANOIA_LEVEL</span> <span class="string">"@lt 2"</span> <span class="string">"id:920013,phase:1,pass,nolog,skipAfter:END-REQUEST-920-PROTOCOL-ENFORCEMENT"</span>	<span class="comment"># PL&lt;2，跳到SecMarker，二级、三级、四级规则无法应用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#二级规则</span></span><br><span class="line"></span><br><span class="line"><span class="string">SecRule</span> <span class="attr">TX:EXECUTING_PARANOIA_LEVEL</span> <span class="string">"@lt 3"</span> <span class="string">"id:920015,phase:1,pass,nolog,skipAfter:END-REQUEST-920-PROTOCOL-ENFORCEMENT"</span>	<span class="comment"># PL&lt;3，跳到到SecMarker，三级、四级规则无法应用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#三级规则</span></span><br><span class="line"></span><br><span class="line"><span class="string">SecRule</span> <span class="attr">TX:EXECUTING_PARANOIA_LEVEL</span> <span class="string">"@lt 4"</span> <span class="string">"id:920017,phase:1,pass,nolog,skipAfter:END-REQUEST-920-PROTOCOL-ENFORCEMENT"</span>	<span class="comment"># PL&lt;4，跳到SecMarker，四级规则无法应用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#四级规则</span></span><br><span class="line"></span><br><span class="line"><span class="string">SecMarker</span> <span class="string">"END-REQUEST-920-PROTOCOL-ENFORCEMENT"</span></span><br></pre></td></tr></table></figure>
<p>所以使用skipAfter和SecMarker，并在每个conf文件中按照级别确定好规则的位置，就可以实现规则分级。</p>
<p>这里的规则分级不仅给每个规则通过位置进行级别的设置，crs还给每个级别的规则进行了字符的限制，用于防御未知的攻击，这部分内容将在后续规则详细解析中介绍。</p>
<p>测试一下，将PL设置为1，然后发送攻击请求，此攻击请求只能命中PL2级别（以932200为例）的规则，但是无法命中PL1规则，此规则为了防护<code>;cat$u+/etc$u/passwd</code>的命令注入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 二级命令注入绕过方式，误报比较高。含有$a 或 \a 或 *a/通配符，并且含有/和\s</span><br><span class="line">SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@rx (?:[*?`\\'][^/\n]+/|\$[(&#123;\[#a-zA-Z0-9]|/[^/]+?[*?`\\'])" \</span><br><span class="line">    <span class="string">"id:932200,\</span></span><br><span class="line"><span class="string">    phase:2,\</span></span><br><span class="line"><span class="string">    block,\</span></span><br><span class="line"><span class="string">    capture,\</span></span><br><span class="line"><span class="string">    t:none,t:lowercase,t:urlDecodeUni,\</span></span><br><span class="line"><span class="string">    msg:'RCE Bypass Technique',\</span></span><br><span class="line"><span class="string">    logdata:'Matched Data: %&#123;TX.0&#125; found within %&#123;MATCHED_VAR_NAME&#125;: %&#123;MATCHED_VAR&#125;',\</span></span><br><span class="line"><span class="string">    tag:'application-multi',\</span></span><br><span class="line"><span class="string">    tag:'language-multi',\</span></span><br><span class="line"><span class="string">    tag:'platform-multi',\</span></span><br><span class="line"><span class="string">    tag:'attack-rce',\</span></span><br><span class="line"><span class="string">    tag:'paranoia-level/2',\</span></span><br><span class="line"><span class="string">    tag:'OWASP_CRS',\</span></span><br><span class="line"><span class="string">    tag:'capec/1000/152/248/88',\</span></span><br><span class="line"><span class="string">    tag:'PCI/6.5.2',\</span></span><br><span class="line"><span class="string">    ver:'OWASP_CRS/3.4.0-dev',\</span></span><br><span class="line"><span class="string">    severity:'CRITICAL',\</span></span><br><span class="line"><span class="string">    chain"</span></span><br><span class="line">    SecRule MATCHED_VAR "@rx /" "t:none,t:urlDecodeUni,chain"</span><br><span class="line">        SecRule MATCHED_VAR "@rx \s" "t:none,t:urlDecodeUni,\</span><br><span class="line">            setvar:'tx.lfi_score=+%&#123;tx.critical_anomaly_score&#125;',\</span><br><span class="line">            setvar:'tx.anomaly_score_pl2=+%&#123;tx.critical_anomaly_score&#125;'"</span><br></pre></td></tr></table></figure>
<p>发送攻击请求，返回200</p>
<p><img src="image-20210720180650475.png" alt="image-20210720180650475"></p>
<p>切换为PL=2，在进行测试，直接返回403</p>
<p><img src="image-20210720180727980.png" alt="image-20210720180727980"></p>
<h4 id="3-2-3-ModSecurity检测模式"><a href="#3-2-3-ModSecurity检测模式" class="headerlink" title="3.2.3 ModSecurity检测模式"></a>3.2.3 ModSecurity检测模式</h4><p>检测模式的配置在crs-setup.conf中，具体通过<code>SecDefaultAction</code>来进行配置</p>
<ol>
<li><p>Self-contained mode：自主机制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SecDefaultAction &quot;phase:1,log,auditlog,deny,status:403&quot;</span><br><span class="line">SecDefaultAction &quot;phase:2,log,auditlog,deny,status:403&quot;</span><br></pre></td></tr></table></figure>
<p>这种机制是非常传统的简单的方式，只要命中其中一条规则，就直接进行拦截，返回403，也可以设置其他动作，各规则之间没有任何联系，当然可以通过规则链的写法进行弥补规则之间的联系，这种优点明显，学习和使用难度很小，理解简单，并且在性能上很优秀，命中规则直接拦截，不需要后续的处理。但是对于目前庞大的规则体系里，使用这种模式肯定是要删除掉大量规则的，比如一些根据rfc进行校验的规则，简单举个例子，将模式设置为自主模式，并且直接403拦截</p>
<p><img src="image-20210719173328574.png" alt="image-20210719173328574"></p>
<p>此请求会被直接403拦截，原因不过是请求得Host是一个ip地址而不是一个域名！所以对于一些本来只需要警告或者提醒的规则，使用自主模式，会造成误报，并且很多规则没法使用。</p>
<p><img src="image-20210719174055580.png" alt="image-20210719174055580"></p>
</li>
<li><p>Anomaly Scoring mode：评分机制，默认机制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SecDefaultAction &quot;phase:1,log,auditlog,pass&quot;</span><br><span class="line">SecDefaultAction &quot;phase:2,log,auditlog,pass&quot;</span><br></pre></td></tr></table></figure>
<p>这种评分机制作为默认机制，是crs体系优点之一，顾名思义，评分机制就是给每个规则赋予一个权重分数，当命中规则的权重分数增加到设定的拦截阈值时，进行拦截。使各条规则之间通过变量的方式进行联系，从而计算总体权重分。对于危险性或者说攻击性不足的规则给予小权重，对于确认很大可能为攻击的规则给与大权重，然后可以根据业务情况来设定拦截阈值，从而在误报和漏报之间寻找平衡，优点十分明显。但是这也增加了使用者的学习难度，加大了性能的消耗，再确认拦截之前需要去匹配大量的规则，并且需要设置变量并进行变量的计算，对性能是一种考验。</p>
<p>crs对于判断不同类型规则的权重分数，有多种类型，并且可以根据各类型进行权重分的积累并设置对应阈值（901中可以看到）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SecAction \</span><br><span class="line">    <span class="string">"id:901200,\</span></span><br><span class="line"><span class="string">    phase:1,\</span></span><br><span class="line"><span class="string">    pass,\</span></span><br><span class="line"><span class="string">    t:none,\</span></span><br><span class="line"><span class="string">    nolog,\</span></span><br><span class="line"><span class="string">    ver:'OWASP_CRS/3.4.0-dev',\</span></span><br><span class="line"><span class="string">    setvar:'tx.anomaly_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.anomaly_score_pl1=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.anomaly_score_pl2=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.anomaly_score_pl3=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.anomaly_score_pl4=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.sql_injection_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.xss_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.rfi_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.lfi_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.rce_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.php_injection_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.http_violation_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.session_fixation_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.inbound_anomaly_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.outbound_anomaly_score=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.outbound_anomaly_score_pl1=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.outbound_anomaly_score_pl2=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.outbound_anomaly_score_pl3=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.outbound_anomaly_score_pl4=0',\</span></span><br><span class="line"><span class="string">    setvar:'tx.sql_error_match=0'"</span></span><br></pre></td></tr></table></figure>
<p>901200是初始化权重分数用的，下面简单介绍几种权重的使用方式，在阈值判断中，默认使用949中的<code>anomaly_score</code>作为总分和阈值进行比较，达到阈值就进行拦截，其他权重分的计算目前只是在日志中记录，利于后续分析与调试。</p>
<h5 id="全局级别分类（severity）："><a href="#全局级别分类（severity）：" class="headerlink" title="全局级别分类（severity）："></a>全局级别分类（severity）：</h5><p>将所有规则分为四类，分别为critical_anomaly_score/error_anomaly_score/warning_anomaly_score/notice_anomaly_score，对应严重，错误，警告，提醒四类，权重由高到低，默认其权重分数在crs-setup.conf中配置，分数对应为5/4/3/2</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SecAction \</span><br><span class="line"> <span class="string">"id:900100,\</span></span><br><span class="line"><span class="string">  phase:1,\</span></span><br><span class="line"><span class="string">  nolog,\</span></span><br><span class="line"><span class="string">  pass,\</span></span><br><span class="line"><span class="string">  t:none,\</span></span><br><span class="line"><span class="string">  setvar:tx.critical_anomaly_score=5,\</span></span><br><span class="line"><span class="string">  setvar:tx.error_anomaly_score=4,\</span></span><br><span class="line"><span class="string">  setvar:tx.warning_anomaly_score=3,\</span></span><br><span class="line"><span class="string">  setvar:tx.notice_anomaly_score=2"</span></span><br></pre></td></tr></table></figure>
<p>将modsecurity设置为评分机制，测试一下评分机制效果</p>
<p><img src="image-20210719181809958.png" alt="image-20210719181809958"></p>
<p>此请求和上面类似，并且设置Accept为空，用来积累权重分，我们看下详细日志</p>
<p><img src="image-20210719181747271.png" alt="image-20210719181747271"></p>
<p>很明显Accept为空是notice，权重为2，Host为ip地址权重为3，总分在<code>949-BLOCKING-EVALUATION</code>规则中被命中，因为总分为5，判断为critical严重级别直接进行拦截。</p>
<p>继续查看<code>949-BLOCKING-EVALUATION</code>d中的949110规则</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SecRule TX:ANOMALY_SCORE "@ge %&#123;tx.inbound_anomaly_score_threshold&#125;" \</span><br><span class="line">    <span class="string">"id:949110,\</span></span><br><span class="line"><span class="string">    phase:2,\</span></span><br><span class="line"><span class="string">    deny,\</span></span><br><span class="line"><span class="string">    t:none,\</span></span><br><span class="line"><span class="string">    msg:'Inbound Anomaly Score Exceeded (Total Score: %&#123;TX.ANOMALY_SCORE&#125;)',\</span></span><br><span class="line"><span class="string">    tag:'application-multi',\</span></span><br><span class="line"><span class="string">    tag:'language-multi',\</span></span><br><span class="line"><span class="string">    tag:'platform-multi',\</span></span><br><span class="line"><span class="string">    tag:'attack-generic',\</span></span><br><span class="line"><span class="string">    ver:'OWASP_CRS/3.4.0-dev',\</span></span><br><span class="line"><span class="string">    severity:'CRITICAL',\</span></span><br><span class="line"><span class="string">    setvar:'tx.inbound_anomaly_score=%&#123;tx.anomaly_score&#125;'"</span></span><br></pre></td></tr></table></figure>
<p>此规则就是来验证总分是否不小于<code>tx.inbound_anomaly_score_threshold</code>阈值的，此参数可以在crs-setup.conf中设置，也可以在901规则文件中配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Default Inbound Anomaly Threshold Level (rule 900110 in setup.conf)</span><br><span class="line">SecRule &amp;TX:inbound_anomaly_score_threshold "@eq 0" \</span><br><span class="line">    <span class="string">"id:901100,\</span></span><br><span class="line"><span class="string">    phase:1,\</span></span><br><span class="line"><span class="string">    pass,\</span></span><br><span class="line"><span class="string">    nolog,\</span></span><br><span class="line"><span class="string">    ver:'OWASP_CRS/3.4.0-dev',\</span></span><br><span class="line"><span class="string">    setvar:'tx.inbound_anomaly_score_threshold=5'"</span></span><br></pre></td></tr></table></figure>
<p>用户可以自定义这些权重分数和阈值来寻找平衡，个人认为应该将critical和notice/warning的权重分数拉大一些，其实在真实环境中，会出现各种奇怪的情况，但是这些都是正常得请求，如果简单的一个notice和warning规则就直接进行拦截，肯定会出现误报情况，所以应该将确认为攻击的规则权重直接设置为阈值，并将notice/warning规则权重减小，并多维度进行分析请求响应，如出现不明显攻击特征或者可能存在误报的数据，再进行拦截，而不是轻易拦截notice/warning积累的一些格式校验未通过的数据。</p>
<h5 id="漏洞类型分类："><a href="#漏洞类型分类：" class="headerlink" title="漏洞类型分类："></a>漏洞类型分类：</h5><p>通过规则防护漏洞类型来进行分类，每一种漏洞类型的全部规则，都共享一个其相对应的权重分变量，如xss类型的规则都共享<code>tx.xss_score</code>变量，命中一个xss规则，<code>tx.xss_score</code>就会相应增加，增加的权重分数由此规则的级别而定也就是上文提到的全局规则的类型，严重，错误，警告，提醒四类</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@pm document.cookie document.write .parentnode .innerhtml window.location -moz-binding &lt;!-- &lt;![cdata[" \</span><br><span class="line">    <span class="string">"id:941180,\</span></span><br><span class="line"><span class="string">    phase:2,\</span></span><br><span class="line"><span class="string">    block,\</span></span><br><span class="line"><span class="string">    capture,\</span></span><br><span class="line"><span class="string">    t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls,\</span></span><br><span class="line"><span class="string">    msg:'Node-Validator Blacklist Keywords',\</span></span><br><span class="line"><span class="string">    logdata:'Matched Data: %&#123;TX.0&#125; found within %&#123;MATCHED_VAR_NAME&#125;: %&#123;MATCHED_VAR&#125;',\</span></span><br><span class="line"><span class="string">    tag:'application-multi',\</span></span><br><span class="line"><span class="string">    tag:'language-multi',\</span></span><br><span class="line"><span class="string">    tag:'platform-multi',\</span></span><br><span class="line"><span class="string">    tag:'attack-xss',\</span></span><br><span class="line"><span class="string">    tag:'paranoia-level/1',\</span></span><br><span class="line"><span class="string">    tag:'OWASP_CRS',\</span></span><br><span class="line"><span class="string">    tag:'capec/1000/152/242',\</span></span><br><span class="line"><span class="string">    ctl:auditLogParts=+E,\</span></span><br><span class="line"><span class="string">    ver:'OWASP_CRS/3.4.0-dev',\</span></span><br><span class="line"><span class="string">    severity:'CRITICAL',\</span></span><br><span class="line"><span class="string">    setvar:'tx.xss_score=+%&#123;tx.critical_anomaly_score&#125;',\</span></span><br><span class="line"><span class="string">    setvar:'tx.anomaly_score_pl1=+%&#123;tx.critical_anomaly_score&#125;'"</span></span><br></pre></td></tr></table></figure>
<p>上面这个规则就是，命中后，xss_score增加critical_anomaly_score。简单测试一个利用多种漏洞攻击的请求</p>
<p><img src="image-20210720173625351.png" alt="image-20210720173625351"></p>
<p>查看日志，可以看到每种漏洞类型的积累分数</p>
<p><img src="image-20210720173828868.png" alt="image-20210720173828868"></p>
<h5 id="PL级别分类："><a href="#PL级别分类：" class="headerlink" title="PL级别分类："></a>PL级别分类：</h5><p>上文提到modsecurity对规则进行了分级，为了后续能够分析每种级别的规则在waf上的效果，评分机制对每一个级别的规则，也进行了权重分的计算，每个级别对应的权重分变量为tx.anomaly_score_pl1/2/3/4,上文中的规则<code>setvar:&#39;tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}</code>就是在命中此PL1规则后，anomaly_score_pl1权重分增加此规则的全局分类权重分critical_anomaly_score。</p>
<p>我们以上文规则分级中的测试为例，modsecurity设置使用PL2，发送会命中PL1、PL2规则的请求</p>
<p><img src="image-20210720182136187.png" alt="image-20210720182136187"></p>
<p>查看日志，可以看到PL各级别的总分</p>
<p><img src="image-20210720182211229.png" alt="image-20210720182211229"></p>
<p>这种类型的权重分总和，默认情况下并没有设置阈值进行拦截，如果业务需要，可以对每一个权重分总和设置阈值，从而当某一分类规则命中权重到达阈值就直接进行拦截，下面为PL级别分数到达10，进行拦截的规则示例</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SecRule TX:ANOMALY_SCORE_PL1 "@ge 10" \</span><br><span class="line">    <span class="string">"id:949999,\</span></span><br><span class="line"><span class="string">    phase:2,\</span></span><br><span class="line"><span class="string">    deny,\</span></span><br><span class="line"><span class="string">    t:none,\</span></span><br><span class="line"><span class="string">    msg:'anomaly score pl1 Exceeded (Total Score: %&#123;TX:ANOMALY_SCORE_PL1&#125;)',\</span></span><br><span class="line"><span class="string">    tag:'application-multi',\</span></span><br><span class="line"><span class="string">    tag:'language-multi',\</span></span><br><span class="line"><span class="string">    tag:'platform-multi',\</span></span><br><span class="line"><span class="string">    tag:'attack-generic',\</span></span><br><span class="line"><span class="string">    ver:'OWASP_CRS/3.4.0-dev',\</span></span><br><span class="line"><span class="string">    severity:'CRITICAL'"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="规则解析"><a href="#规则解析" class="headerlink" title="规则解析"></a>规则解析</h2><p>Version:    OWASP_CRS/4.0-dev</p>
<p>原版文档：<a href="https://github.com/SpiderLabs/ModSecurity/wiki/" target="_blank" rel="noopener">https://github.com/SpiderLabs/ModSecurity/wiki/</a>    x版本没有:)</p>
<p>中文参考：<a href="http://www.modsecurity.cn/chm/" target="_blank" rel="noopener">http://www.modsecurity.cn/chm/</a></p>
<h3 id="4-1-规则参数解析"><a href="#4-1-规则参数解析" class="headerlink" title="4.1 规则参数解析"></a>4.1 规则参数解析</h3><p>通用格式</p>
<p>SecRule VARIABLES OPERATOR [TRANSFORMATION_FUNCTIONS, ACTIONS]</p>
<p>接下来将选取重要的参数进行介绍</p>
<h4 id="4-1-1-变量"><a href="#4-1-1-变量" class="headerlink" title="4.1.1 变量"></a>4.1.1 变量</h4><h5 id="4-1-1-1-Request-variables"><a href="#4-1-1-1-Request-variables" class="headerlink" title="4.1.1.1 Request variables"></a>4.1.1.1 Request variables</h5><p>ARGS 请求参数，类型read-only collection<br>ARGS_COMBINED_SIZE 请求参数的总大小<br>ARGS_NAMES 请求参数的名字， 类型read-only collection<br>ARGS_GET 查询字符串参数，类型read-only collection<br>ARGS_GET_NAMES 查询字符串参数,类型read-only collection<br>ARGS_POST 请求体参数，类型read-only collection<br>ARGS_POST_NAMES 请求体参数的名字，类型read-only collection<br>FILES 上传文件域，类型read-only collection<br>FILES_COMBINED_SIZE 上传文件大小<br>FILES_NAMES 上传文件表单文件域参数的名字，类型read-only collection<br>FILES_SIZES 上传文件的大小，类型read-only collection<br>FILES_TMPNAMES 文件临时名字，类型read-only collection<br>PATH_INFO  URI path<br>QUERY_STRING 查询字符串<br>REQUESET_BASENAME URI basename，同时支持/与\这两种文件分隔符<br>REQUEST_BODY 请求体，默认处理application/x-www-form-urlencoded 请求<br>REQUEST_COOKIES cookie参数<br>REQUEST_COOKIES_NAMES cookie参数的名字，类型read-only collection<br>REQUEST_FILENAME URI filename/path<br>REQUEST_HEADERS 请求头，类型read-only collection<br>REQUEST_HEADERS_NAMES 请求头参数的名字， 类型read-only collection<br>REQUEST_LINE  请求行<br>REQUEST_METHOD 请求方法<br>REQUEST_PROTOCOL 请求协议<br>REQUEST_URI   请求URI,但不包括hostname<br>REQUEST_URI_RAW 请求URI,包括hostname</p>
<h5 id="4-1-1-2-Server-variables"><a href="#4-1-1-2-Server-variables" class="headerlink" title="4.1.1.2 Server variables"></a>4.1.1.2 Server variables</h5><p>AUTH_TYPE  认证类型，代理模式下非本地认证，需要指定Authorization头<br>REMOTE_ADDR 远程地址， 访问者ip<br>REMOTE_HOST 远程host，访问者hostname，当HostnameLookUps开启时，为dns解析的域名，否则为ip地址<br>REMOTE_PORT 远程端口，访问者端口<br>REMOTE_USER 访问者用户名<br>SERVER_ADDR 服务端地址<br>SERVER_NAME 服务端hostname，取值Host请求头<br>SERVER_PORT 服务端端口<br>SCRIPT_BASENAME 脚本basename, 代理模式不可用<br>SCRIPT_FILENAME 脚本 filename，代理模式不可用<br>SCRIPT_GID 脚本group ID，代理模式不可用<br>SCRIPT_GROUPNAME 脚本 group name，代理模式不可用<br>SCRIPT_MODE 脚本权限 ，代理模式不可用<br>SCRIPT_UID 脚本 user ID，代理模式不可用<br>SCRIPT_USERNAME 脚本 user name，代理模式不可用</p>
<h5 id="4-1-1-3-Response-variables"><a href="#4-1-1-3-Response-variables" class="headerlink" title="4.1.1.3 Response variables"></a>4.1.1.3 Response variables</h5><p>RESPONSE_BODY 响应体<br>RESPONSE_CONTENT_LENGTH 响应实体长度，单位bytes<br>RESPONSE_CONTENT_TYPE 响应实体类型，仅仅在phase3可用<br>RESPONSE_HEADERS 响应头，类型read-only collection<br>在内嵌模式中，像那种会优先将数据发送给客户端的响应头是不可获得的，例如Server,Date,Connection,Content-Type<br>在代理模式中，阶段5可用<br>RESPONSE_HEADERS_NAMES 响应头参数的名字，类型read-only collection<br>在内嵌模式中，像那种会优先将数据发送给客户端的响应头是不可获得的，例如Server,Date,Connection,Content-Type<br>在代理模式中，阶段5可用<br>RESPONSE_PROTOCOL 响应协议<br>RESPONSE_STATUS 响应码，仅代理模式可用</p>
<h5 id="4-1-1-4-Parsing-flags"><a href="#4-1-1-4-Parsing-flags" class="headerlink" title="4.1.1.4 Parsing flags"></a>4.1.1.4 Parsing flags</h5><p>MULTIPART_BOUNDARY_QUOTED  multipart 解析错误：boudnary中有引号<br>MULTIPART_BOUNDARY_WHITESPACE multipart 解析错误：boudnary中有空格<br>MULTIPART_CRLF_LF_LINES multipart 解析错误：混合使用\r\n 与\n作为分界线， 当允许使用混合粉各符时设置为1<br>MULTIPART_DATA_BEFORE multipart 解析错误：第一个boudnary前有数据<br>MULTIPART_DATA_AFTER multipart 解析错误：最后一个boudnary后有数据<br>MUTLIPART_HEADER_FOLDING multipart 解析错误：boudnary中<br>MULTIPART_LF_LINE multipart 解析错误：使用\n作为分界线<br>MULTIPART_SEMICOLON_MISSIONG multipart 解析错误：缺少分号<br>MULTIPART_STRICT_ERROR 当以下值为1时，该值为1;<br>REQBODY_PROCESSOR_ERROR<br>MULTIPART_BOUNDARY_QUOTED<br>MULTIPART_BOUNDARY_WHITESPACE<br>MULTIPART_DATA_BEFORE<br>MULTIPART_DATA_AFTER<br>MULTIPART_HEADER_FOLDING<br>MULTIPART_LF_LINE 使用换行做分界线<br>MULTPART_SEMICOLON_MISSING 分号缺失<br>MULTPART_INVALID_QUOTING 无效引号<br>MULTIPART_INVALID_QUOTING  multipart 解析错误： 无效引号<br>MULTIPART_UNMATCHED_BOUDDARY multipart 解析错误：不合规范的boudnary，容易漏报<br>REQBODY_PROCESSOR 处理request解析，内置的解析功能包括URLENCODED, MULTIPART, XML<br>REQBODY_PROCESSOR_ERROR  request解析错误标记，1表示错误，0表示ok<br>REQBODY_PROCESSOR_ERROR_MSG request解析错误信息<br>URLENCODED_ERROR 当解析application/x-www-form-urlencoded格式的请求体出错时值为1</p>
<h4 id="4-1-2-操作符"><a href="#4-1-2-操作符" class="headerlink" title="4.1.2 操作符"></a>4.1.2 操作符</h4><p>@beginsWith<br>@contains<br>@containsWord<br>@endsWith<br>@rx  Regular pattern match 正则<br>@pm  特征字符串的匹配，　大小不敏感，基于Aho-Corasick匹配算法<br>@pmFromFile 从文件读取匹配特征字符串 ，Parallel matching, with arguments from a file<br>@streq String equal to<br>@within   Within<br>@eq 相等<br>@ge 大于等于<br>@gt 大于<br>@le 小于等于<br>@lt 小于<br>@validateByteRange<br>@validateDTD XML相关<br>@validateSchema XML相关<br>@validateUrlEncoding<br>@validateUtf8Encoding<br>@geoLookup Determines the physical location of an IP address<br>@inspectFile 使用外部脚本处理<br>@rbl  去RBL REAL-TIME BLANKHOLE LISTS反垃圾邮件黑名单里查找ipv4地址，或hostname<br>@verifyCC  Checks if the parameter is a valid credit card number</p>
<h4 id="4-1-3-转换函数"><a href="#4-1-3-转换函数" class="headerlink" title="4.1.3 转换函数"></a>4.1.3 转换函数</h4><p>base64Decode<br>base64Encode<br>compressWhitespace<br>cssDecode<br>escapeSeqDecode　<br>hexDecode<br>hexEncode<br>htmlEntityDecode<br>jsDecode<br>length<br>lowercase<br>md5<br>normalizePath 移除掉多个斜杠<br>normalizePathWin 移除掉多个斜杠,但首先会将\转化成/<br>parityEven7bit<br>parityOdd7bit<br>parityZero7bit<br>removeNulls 删除空字节<br>removeWhiteSpace 删除空格字符<br>replaceComments 将注释语句/<em>…</em>/转换为空格<br>replaceNulls 将NULL字节转换为空格<br>urlDecode<br>urlDecodeUni<br>urlEncode<br>sha1<br>trimLeft 移除左边的空格<br>trimeRight 移除右边的空格<br>trim  移除左右两端的空格</p>
<h4 id="4-1-4-动作"><a href="#4-1-4-动作" class="headerlink" title="4.1.4 动作"></a>4.1.4 动作</h4><p>allow<br>2.5版本之前是只影响当前阶段<br>2.5版本之后，如果单独使用，除了log阶段，其他阶段都停止处理，如果和参数phase一起使用，allow将停止当前阶段的处理，其他阶段不受影响<br>block 相当于占位符，会被上下文的SecDefaultAction 指令中的动作取代<br>deny 使用错误页面block 当前事务,Block transaction with an error page<br>drop 断开网络连接<br>pass 继续执行下一个规则<br>proxy 代理请求到后端web server<br>redirect 重定向请求到其他web server<br>chain 相当于多个规则的and操作<br>skip 跳过指定的规则,值为跳过的规则个数，不能跳过同一个规则链中的规则<br>skipAfter 调转到指定的规则<br>id  设置规则ID<br>phase　指明处理阶段<br>msg<br>rev  设置版本号<br>severity　设置rule的严重级别，最好用文本来指定，v2.5.0版本已弃用<br>capture 将捕获结果存入ＴＸ变量，可以存储１０个变量，ｔｘ变量集合的下标为０－９<br>deprecatevar 设置指定时间内递减数字型变量<br>expirevar 设置指定时间内移除过期的变量<br>initcol 创建持久性collections，通常在阶段１中设置<br>setenv 设置环境变量<br>setvar 设置变量<br>setuid 设置当前事务的user ID<br>setsid 设置当前事务的session ID<br>auditlog 将当前事务记录到审计log中<br>log   Log error message; implies auditlog<br>logdata  Log supplied data as part of error message<br>noauditlog Do not log current transaction to audit log<br>nolog Do not log error message; implies noauditlog</p>
<h3 id="4-2-具体规则解析"><a href="#4-2-具体规则解析" class="headerlink" title="4.2 具体规则解析"></a>4.2 具体规则解析</h3><p>规则具体的全局配置在crs-setup.conf中</p>
<h4 id="901"><a href="#901" class="headerlink" title="901"></a>901</h4><p><em>901-INITIALIZATION</em>    初始化变量定义</p>
<h4 id="903"><a href="#903" class="headerlink" title="903"></a>903</h4><p>一些应用漏洞防护规则</p>
<p>9001：DRUPAL</p>
<p>9002：WOEDPRESS</p>
<p>9003：NEXTCLOUD</p>
<p>9004：DOKUWIKI</p>
<p>9005：CPANEL</p>
<p>9006：XENFORO</p>
<p>9007：PHPBB</p>
<p>9008：PHPMYADMIN</p>
<h4 id="905"><a href="#905" class="headerlink" title="905"></a>905</h4><p><em>905-COMMON-EXCEPTIONS</em>    常见的两种请求情况Apache SSL pinger和Apache internal dummy connection，关闭ruleEngine和auditEngine</p>
<h4 id="910"><a href="#910" class="headerlink" title="910"></a>910</h4><p><em>910-IP-REPUTATION</em>     IP信誉库，可以直接连接第三方IP信誉库</p>
<h4 id="911"><a href="#911" class="headerlink" title="911"></a>911</h4><p><em>911-METHOD-ENFORCEMENT</em>    PL1-允许请求方法</p>
<h4 id="912"><a href="#912" class="headerlink" title="912"></a>912</h4><p><em>912-DOS-PROTECTION</em>    DOS防护</p>
<ul>
<li><p>PL0</p>
<p>912100/912110：如果没有这是dos防护参数，就直接跳过dos防护规则</p>
</li>
<li><p>PL1</p>
<p>912150：记录非静态文件访问次数</p>
<p>912160/912161：请求数超过用户设置，就进行记录，一种从0-1，一种从1-2，不会超过2</p>
<p>912170：当超过次数为2时，认定为潜在的dos攻击</p>
</li>
<li><p>PL2</p>
<p>912171：同912170，次数为1时，就认定为潜在的dos攻击</p>
</li>
</ul>
<h4 id="913"><a href="#913" class="headerlink" title="913"></a>913</h4><p><em>913-SCANNER-DETECTION</em>     扫描器检测</p>
<p>都为PL1规则，通过关键字进行检测，关键字列表见data文件</p>
<h4 id="920"><a href="#920" class="headerlink" title="920"></a>920</h4><p><em>920-PROTOCOL-ENFORCEMENT</em>    协议强制规则</p>
<p>根据RFC对http协议的规范编写的规则，包括编码、request_header、ascii字符范围、请求参数最大长度等限制，多为NOTICE/WARNING level</p>
<p>还有一些对uri限制的规则，如文件扩展名</p>
<ul>
<li><p>PL0</p>
<ol>
<li>920100：request_header(eg.<code>POST /index.html HTTP/1.1</code>)验证</li>
</ol>
</li>
<li><p>PL1</p>
<ol>
<li><p>920120：文件名和文件参数名验证，没看懂</p>
</li>
<li><p>920160：Content-Length取值非数字</p>
</li>
<li><p>920170：非GET/HEAD方法，Content-Length不能取0或者无值</p>
</li>
<li><p>920172：GET/HEAD方法，不能含有Transfer-Encoding</p>
</li>
<li><p>920180：非HTTP/2协议，post方法，CL TE不能同时不存在</p>
</li>
<li><p>920181：CL TE不能同时存在</p>
</li>
<li><p>920190：HTTP request_header:Range，范围必须从小到大</p>
</li>
<li><p>920210：Connection不能取两个值</p>
</li>
<li><p>920220/920240：验证url编码准确性</p>
</li>
<li><p>920250：验证utf8编码准确性</p>
</li>
<li><p>920260：宽字节编码</p>
</li>
<li><p><em>920270</em>：</p>
<p>全局设置规则应用的级别paranoia level，可在crs-setup.conf中设置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">SecAction</span> <span class="string">\</span></span><br><span class="line">   <span class="string">"id:900000,\</span></span><br><span class="line"><span class="string">   phase:1,\</span></span><br><span class="line"><span class="string">   nolog,\</span></span><br><span class="line"><span class="string">   pass,\</span></span><br><span class="line"><span class="string">   t:none,\</span></span><br><span class="line"><span class="string">   setvar:tx.paranoia_level=1"</span></span><br></pre></td></tr></table></figure>
<p>920270中解释了，每个级别中限制通行的ByteRange</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -=[ Targets and ASCII Ranges ]=-</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 920270: PL1 : REQUEST_URI, REQUEST_HEADERS, ARGS and ARGS_NAMES</span></span><br><span class="line"><span class="comment">#       ASCII 1-255 : Full ASCII range without null character</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 920271: PL2 : REQUEST_URI, REQUEST_HEADERS, ARGS and ARGS_NAMES</span></span><br><span class="line"><span class="comment">#       ASCII 9,10,13,32-126,128-255 : Full visible ASCII range, tab, newline</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 920272: PL3 : REQUEST_URI, REQUEST_HEADERS, ARGS, ARGS_NAMES and REQUEST_BODY</span></span><br><span class="line"><span class="comment">#       ASCII 32-36,38-126 : Visible lower ASCII range without percent symbol</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 920273: PL4 : ARGS, ARGS_NAMES and REQUEST_BODY</span></span><br><span class="line"><span class="comment">#       ASCII 38,44-46,48-58,61,65-90,95,97-122</span></span><br><span class="line"><span class="comment">#       A-Z a-z 0-9 = - _ . , : &amp;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 920274: PL4 : REQUEST_HEADERS without User-Agent, Referer, Cookie</span></span><br><span class="line"><span class="comment">#               and Structured Header booleans</span></span><br><span class="line"><span class="comment">#       ASCII 32,34,38,42-59,61,65-90,95,97-122</span></span><br><span class="line"><span class="comment">#       A-Z a-z 0-9 = - _ . , : &amp; " * + / SPACE</span></span><br></pre></td></tr></table></figure>
<p>PL取值越大，其可通行的字符范围越小，而且由于字符范围越小，也会应用更多的规则。很多规则会因为PL级别很小，导致会被忽略，不进行匹配拦截</p>
<ol>
<li>920280：不允许Host字段不存在</li>
<li>920290：不允许Host取值为空</li>
<li>920310：非OPTIONS方法，非特定一些UA，不允许Accept取值为空</li>
<li>920311：不允许非OPTIONS方法，Accept取值为空，并不存在UA</li>
<li>920330：不允许UA取值为空</li>
<li>920340：CL取值大于0，必须存在Content-Type</li>
<li>920350：Host非域名</li>
<li>920380：最大请求参数数量限制</li>
<li>920360：请求参数名的长度</li>
<li>920370：请求参数值长度</li>
<li>920390：请求参数总长度</li>
<li>920400：最大上传文件大小</li>
<li>920410：总上传文件大小</li>
<li>920470/920420/920480：Content-Type限制</li>
<li>920430：请求http协议限制</li>
<li>920440：url文件扩展名限制</li>
<li>920500：url文件名称限制，eg:<code>index.php~</code></li>
<li>920450：请求头限制</li>
</ol>
</li>
</ol>
</li>
<li><p>PL2</p>
<ol>
<li>920200/920201：Range头取值个数限制</li>
<li>920230：url多次编码检测</li>
<li>920271：可用字符限制规则，同920270</li>
<li>920230：UA存在</li>
<li>920121：上传文件名不能含有[‘\”;=]</li>
<li>920341：Content-Length不等于0时，必须存在Content-Type</li>
</ol>
</li>
<li><p>PL3</p>
<ol>
<li>920272：可用字符规则，同920270</li>
<li>920300：非Option方法，除特定UA，Accept必须存在</li>
<li>920490：针对x-up-devcap-post-charset头的规则，<a href="https://soroush.secproject.com/blog/2019/05/x-up-devcap-post-charset-header-in-aspnet-to-bypass-wafs-again/" target="_blank" rel="noopener">blog</a></li>
<li>920510：Cache-Control白名单</li>
</ol>
</li>
<li><p>PL4</p>
<ol>
<li>920202：同920200</li>
<li>920273/920274/920275：可用字符限制规则，同920270</li>
<li>920460：防御类似<code>arg=cat+/e\tc/pa\ssw\d</code>，误报率不用说，很高</li>
</ol>
</li>
</ul>
<h4 id="921"><a href="#921" class="headerlink" title="921"></a>921</h4><p><em>921-PROTOCAL-ATTACK</em>     防御协议攻击的规则 </p>
<ul>
<li><p>PL1</p>
<ol>
<li>921110：HTTP走私，请求方法关键字</li>
<li>921120：HTTP响应拆分攻击，[\r\n]和常见header</li>
<li>921130：response头http/，和常用xss标签\&lt;html>\&lt;meta></li>
<li>921140：request_header中含有[\r\n]</li>
<li>921150：参数名中含有[\r\n]</li>
<li>921160：参数中含有[\r\n]和常见request_header</li>
<li>921190：请求中文件名不能含有[\r\n]，类似uri</li>
<li>921200：LDAP注入规则，必须要有)闭合括号才能匹配中，eg.<code>)(!)</code></li>
</ol>
</li>
<li><p>PL2</p>
<p>921151：GET参数值中含有[\r\n]</p>
</li>
<li><p>PL3</p>
<p>921170/921180：HTTP参数污染漏洞规则，先将每一个参数名都匹配出来，并以paramcounter_为前缀增加变量进行计数，最后如果相同参数名含有两个值或以上就拦截</p>
</li>
</ul>
<h4 id="930"><a href="#930" class="headerlink" title="930"></a>930</h4><p><em>930-APPLICATION-ATTACK-LFI</em> 本地文件包含漏洞规则</p>
<ul>
<li>PL1<ol>
<li>930050：Google OAuth2 callback 检测</li>
<li>930100：url编码过的payloads eg.<code>urlencode(/../)</code></li>
<li>930110：普通../和/.. ..\和..</li>
<li>930120/930121/930130：一些常见的本地文件列表关键字，具体内容见data数据</li>
</ol>
</li>
</ul>
<h4 id="931"><a href="#931" class="headerlink" title="931"></a>931</h4><p><em>931-APPLICATION-ATTACK-RFI</em> 远程文件包含漏洞规则</p>
<ul>
<li>PL1<ol>
<li>931100：file/ftps/https://协议加数字ip形式</li>
<li>931110：文件包含的参数名如include</li>
<li>931120：file/ftps/https://协议，误报很高</li>
</ol>
</li>
<li>PL2<ol>
<li>931130：出现file://类似关键字就直接拦截，且包含host地址，与请求host不同，误报高</li>
</ol>
</li>
</ul>
<h4 id="932"><a href="#932" class="headerlink" title="932"></a>932</h4><p>APPLICATION-ATTACK-RCE    远程代码执行(代码注入)</p>
<ul>
<li>PL1<ol>
<li>932100：regexp-932100.txt中各种uninx命令的拦截 </li>
<li>932110：windows命令拦截</li>
<li>932120：powershell命令</li>
<li>932130：unix命令表达式bypass拦截，缺少$\w+，变量未定义默认为空，可以绕过 ;cat$a+/etc&amp;b/passed$c/</li>
<li>932180：配置文件上传导致的RCE</li>
</ol>
</li>
<li>PL2<ol>
<li>932200：二级命令注入绕过方式，误报比较高。含有$a 或 \a 或 *a/通配符，并且含有/和\s</li>
<li>932210：sqlite cli命令注入拦截规则，不错，二级规则，但是误报率不会大</li>
</ol>
</li>
<li>PL3<ol>
<li>932106：增加的命令拦截</li>
<li>932190：通配符命令增加规则</li>
</ol>
</li>
</ul>
<h4 id="933"><a href="#933" class="headerlink" title="933"></a>933</h4><p>933-APPLICATION-ATTACK-PHP  php攻击防护，可根据后端应用类型开启</p>
<h4 id="934"><a href="#934" class="headerlink" title="934"></a>934</h4><p>934-APPLICATION-ATTACK-NODEJS nodejs攻击防护，可根据后端应用类型开启</p>
<h4 id="943"><a href="#943" class="headerlink" title="943"></a>943</h4><ul>
<li>PL1<ol>
<li>943100：会话固定攻击 <a href="http://projects.webappsec.org/Session-Fixation" target="_blank" rel="noopener">Session-Fixation</a></li>
<li>943110：参数名中含有session设置的关键词，并且referer和请求host不一致，感觉误报很多</li>
<li>943120：参数名中含有session关键词，且没有referer，误报超高应该</li>
</ol>
</li>
</ul>
<h4 id="944"><a href="#944" class="headerlink" title="944"></a>944</h4><p>944-APPLICATION-ATTACK-JAVA java攻击防护，可根据后端应用类型开启</p>
<h4 id="95x"><a href="#95x" class="headerlink" title="95x"></a>95x</h4><p>950-954 DATA-LEAKAGES 数据泄露规则，主要返回包中含有相关关键字</p>
<h4 id="955"><a href="#955" class="headerlink" title="955"></a>955</h4><p>955-WEB-SHELLS webshell规则，主要是国外常见webshell规则，国内没啥用</p>
<h3 id="4-3-一个绕过案例"><a href="#4-3-一个绕过案例" class="headerlink" title="4.3 一个绕过案例"></a>4.3 一个绕过案例</h3><p>先看一个简单的规则</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|!REQUEST_HEADERS:Referer|XML:/* "@rx (?:(?:^|[\\/])\.\.[\\/]|[\\/]\.\.(?:[\\/]|$))" \</span><br><span class="line">    <span class="string">"id:930110,\</span></span><br><span class="line"><span class="string">    phase:2,\</span></span><br><span class="line"><span class="string">    block,\</span></span><br><span class="line"><span class="string">    capture,\</span></span><br><span class="line"><span class="string">    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:cmdLine,\</span></span><br><span class="line"><span class="string">    msg:'Path Traversal Attack (/../)',\</span></span><br><span class="line"><span class="string">    logdata:'Matched Data: %&#123;TX.0&#125; found within %&#123;MATCHED_VAR_NAME&#125;: %&#123;MATCHED_VAR&#125;',\</span></span><br><span class="line"><span class="string">    tag:'application-multi',\</span></span><br><span class="line"><span class="string">    tag:'language-multi',\</span></span><br><span class="line"><span class="string">    tag:'platform-multi',\</span></span><br><span class="line"><span class="string">    tag:'attack-lfi',\</span></span><br><span class="line"><span class="string">    tag:'paranoia-level/1',\</span></span><br><span class="line"><span class="string">    tag:'OWASP_CRS',\</span></span><br><span class="line"><span class="string">    tag:'capec/1000/255/153/126',\</span></span><br><span class="line"><span class="string">    ver:'OWASP_CRS/3.4.0-dev',\</span></span><br><span class="line"><span class="string">    severity:'CRITICAL',\</span></span><br><span class="line"><span class="string">    multiMatch,\</span></span><br><span class="line"><span class="string">    setvar:'tx.anomaly_score_pl1=+%&#123;tx.critical_anomaly_score&#125;',\</span></span><br><span class="line"><span class="string">    setvar:'tx.lfi_score=+%&#123;tx.critical_anomaly_score&#125;'"</span></span><br></pre></td></tr></table></figure>
<p>需要关注的就是，待检测数据在匹配规则之前，会进行数据的转换，由t这个动作完成，后面跟的就是需要什么转换函数来进行转化，上文已经列举了相关的函数。这些函数可以从代码中看到</p>
<p><img src="image-20210827143140621.png" alt="image-20210827143140621"></p>
<p>测试时，我发现这个防止本地文件包含的规则经过cmlLine函数的转换，接着查看其转化代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> CmdLine::evaluate(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;value,</span><br><span class="line">    Transaction *transaction) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> ret;</span><br><span class="line">    <span class="keyword">int</span> space = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; a : value) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (a) &#123;</span><br><span class="line">            <span class="comment">/* remove some characters */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'"'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\''</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\\'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'^'</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* replace some characters to space (only one) */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">','</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">';'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\t'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\r'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\n'</span>:</span><br><span class="line">                <span class="keyword">if</span> (space == <span class="number">0</span>) &#123;</span><br><span class="line">                    ret.append(<span class="string">" "</span>);</span><br><span class="line">                    space++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* remove space before / or ( */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'('</span>:</span><br><span class="line">                <span class="keyword">if</span> (space) &#123;</span><br><span class="line">                    ret.pop_back();</span><br><span class="line">                &#125;</span><br><span class="line">                space = <span class="number">0</span>;</span><br><span class="line">                ret.append(&amp;a, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* copy normal characters */</span></span><br><span class="line">            <span class="keyword">default</span> :</span><br><span class="line">                <span class="keyword">char</span> b = <span class="built_in">std</span>::<span class="built_in">tolower</span>(a);</span><br><span class="line">                ret.append(&amp;b, <span class="number">1</span>);</span><br><span class="line">                space = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显主要是删除一些命令注入bypass的关键字符如<code>&quot;&#39;\^</code>，并将一些字符转换成空格，但是930110这个规则主要防御的就是<code>/../</code>或者<code>\..\</code>类似的攻击，这就导致<code>\</code>会被删除。</p>
<p>然后我搭建了Apache/2.4.29+CRSv3.4/dev+PL1的环境进行测试payload: <code>..\secret</code></p>
<p><img src="image-20210827154633740.png" alt="image-20210827154633740"></p>
<p>结果不出所料，直接绕过了modsecurity最新规则，接着我直接提了<a href="https://github.com/coreruleset/coreruleset/issues/2140" target="_blank" rel="noopener">issue</a>给CRS，一开始他们不确定这是个绕过，最后又承认是<code>False Negative</code></p>
<p><img src="image-20210827154937977.png" alt="image-20210827154937977"></p>
<p>之后就没再关注这个东西，最近发现事情远没有这么简单，如果只是简单的删除掉规则中的cmdLine转换函数并不能解决掉这个漏报，修改规则并测试</p>
<p><img src="image-20210827161434572.png" alt="image-20210827161434572"></p>
<p>发现还是未拦截，根据issue中的回复来看，参考此前的一个<a href="https://github.com/SpiderLabs/ModSecurity/issues/2148" target="_blank" rel="noopener"> SpiderLabs/ModSecurity#2148</a>，简单来说就是双斜杠<code>\\</code>在经过Apache解析时，会转化成一个<code>\</code>最终正则变为了<code>(?:^|[\/])\.\.(?:[\/]|$)</code>，所以无法匹配<code>..\</code></p>
<p><img src="image-20210827161628439.png" alt="image-20210827161628439"></p>
<p>接着我也测试了将规则改为<code>(?:^|[\\\\/])\.\.(?:[\\\\/]|$)</code>，确实能够准确拦截，可是在没有删除cmdLine函数转换的情况下也拦截了</p>
<p><img src="image-20210827161859982.png" alt="image-20210827161859982"></p>
<p>可是这并没有解决我一开始的问题，确实拦截了，但即使正则在解析之后是准确的，而<code>..\secret</code>经过处理<code>\</code>应该被删除才对。</p>
<p>接着为了测试是否cmdLine函数起作用</p>
<p><img src="image-20210827163252780.png" alt="image-20210827163252780"></p>
<p><code>..&quot;/a</code>直接拦截，说明cmdLine没有问题，接着测试<code>.&quot;.\a</code>时</p>
<p><img src="image-20210827163702220.png" alt="image-20210827163702220"></p>
<p>目前也没发现具体原因是什么导致的，当然从结果上来说，不影响具体waf的拦截情况。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.modsecurity.cn/" target="_blank" rel="noopener">http://www.modsecurity.cn/</a></p>
<p><a href="https://github.com/SpiderLabs/ModSecurity/wiki/" target="_blank" rel="noopener">https://github.com/SpiderLabs/ModSecurity/wiki/</a></p>
<p><a href="https://www.cnblogs.com/wuweidong/p/8535048.html" target="_blank" rel="noopener">https://www.cnblogs.com/wuweidong/p/8535048.html</a></p>
<p><a href="https://www.cnblogs.com/Hi-blog/p/ModSecurity-Transaction-Lifecycle.html" target="_blank" rel="noopener">https://www.cnblogs.com/Hi-blog/p/ModSecurity-Transaction-Lifecycle.html</a></p>
<p><a href="https://www.shuzhiduo.com/A/QV5ZZV1y5y/" target="_blank" rel="noopener">https://www.shuzhiduo.com/A/QV5ZZV1y5y/</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/WAF/" rel="tag"># WAF</a>
          
            <a href="/tags/ModSecurity/" rel="tag"># ModSecurity</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/05/21/从RFC规范看如何绕过waf上传表单/" rel="next" title="从RFC规范看如何绕过waf上传表单">
                <i class="fa fa-chevron-left"></i> 从RFC规范看如何绕过waf上传表单
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/07/22/Apache-Tomcat-HTTP请求走私-CVE-2021-33037-漏洞分析/" rel="prev" title="Apache Tomcat HTTP请求走私(CVE-2021-33037)漏洞分析">
                Apache Tomcat HTTP请求走私(CVE-2021-33037)漏洞分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">donky16</p>
              <p class="site-description motion-element" itemprop="description">质性自然，非矫历所得</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-介绍"><span class="nav-number">1.1.</span> <span class="nav-text">1. 介绍</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Libmodsecurity"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 Libmodsecurity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Nginx-modsecurity"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 Nginx-modsecurity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Apache2-modsecurity"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 Apache2-modsecurity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-测试拦截"><span class="nav-number">2.4.</span> <span class="nav-text">2. 测试拦截</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-nginx-log"><span class="nav-number">2.4.1.</span> <span class="nav-text">2.1 nginx log</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-apache2-log"><span class="nav-number">2.4.2.</span> <span class="nav-text">2.2 apache2 log</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引擎规则体系"><span class="nav-number">3.</span> <span class="nav-text">引擎规则体系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-规则引擎配置"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 规则引擎配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-规则体系解析"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 规则体系解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-ModSecurity事务生命周期"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1 ModSecurity事务生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-ModSecurity全局规则配置级别"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2 ModSecurity全局规则配置级别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-ModSecurity检测模式"><span class="nav-number">3.2.3.</span> <span class="nav-text">3.2.3 ModSecurity检测模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#全局级别分类（severity）："><span class="nav-number">3.2.3.1.</span> <span class="nav-text">全局级别分类（severity）：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#漏洞类型分类："><span class="nav-number">3.2.3.2.</span> <span class="nav-text">漏洞类型分类：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PL级别分类："><span class="nav-number">3.2.3.3.</span> <span class="nav-text">PL级别分类：</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#规则解析"><span class="nav-number">4.</span> <span class="nav-text">规则解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-规则参数解析"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 规则参数解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-变量"><span class="nav-number">4.1.1.</span> <span class="nav-text">4.1.1 变量</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-1-1-Request-variables"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">4.1.1.1 Request variables</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-1-2-Server-variables"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">4.1.1.2 Server variables</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-1-3-Response-variables"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">4.1.1.3 Response variables</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-1-4-Parsing-flags"><span class="nav-number">4.1.1.4.</span> <span class="nav-text">4.1.1.4 Parsing flags</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-操作符"><span class="nav-number">4.1.2.</span> <span class="nav-text">4.1.2 操作符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-3-转换函数"><span class="nav-number">4.1.3.</span> <span class="nav-text">4.1.3 转换函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-4-动作"><span class="nav-number">4.1.4.</span> <span class="nav-text">4.1.4 动作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-具体规则解析"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 具体规则解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#901"><span class="nav-number">4.2.1.</span> <span class="nav-text">901</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#903"><span class="nav-number">4.2.2.</span> <span class="nav-text">903</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#905"><span class="nav-number">4.2.3.</span> <span class="nav-text">905</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#910"><span class="nav-number">4.2.4.</span> <span class="nav-text">910</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#911"><span class="nav-number">4.2.5.</span> <span class="nav-text">911</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#912"><span class="nav-number">4.2.6.</span> <span class="nav-text">912</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#913"><span class="nav-number">4.2.7.</span> <span class="nav-text">913</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#920"><span class="nav-number">4.2.8.</span> <span class="nav-text">920</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#921"><span class="nav-number">4.2.9.</span> <span class="nav-text">921</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#930"><span class="nav-number">4.2.10.</span> <span class="nav-text">930</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#931"><span class="nav-number">4.2.11.</span> <span class="nav-text">931</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#932"><span class="nav-number">4.2.12.</span> <span class="nav-text">932</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#933"><span class="nav-number">4.2.13.</span> <span class="nav-text">933</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#934"><span class="nav-number">4.2.14.</span> <span class="nav-text">934</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#943"><span class="nav-number">4.2.15.</span> <span class="nav-text">943</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#944"><span class="nav-number">4.2.16.</span> <span class="nav-text">944</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#95x"><span class="nav-number">4.2.17.</span> <span class="nav-text">95x</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#955"><span class="nav-number">4.2.18.</span> <span class="nav-text">955</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-一个绕过案例"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 一个绕过案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">donky16</span>

  
</div>

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
