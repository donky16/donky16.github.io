<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans,en,default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="WAF,HTTP,multipart/form-data,RFC," />










<meta name="description" content="文章首发于安全客，分上下两篇，此为完整版本">
<meta name="keywords" content="WAF,HTTP,multipart&#x2F;form-data,RFC">
<meta property="og:type" content="article">
<meta property="og:title" content="从RFC规范看如何绕过waf上传表单">
<meta property="og:url" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/index.html">
<meta property="og:site_name" content="donky16">
<meta property="og:description" content="文章首发于安全客，分上下两篇，此为完整版本">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210506165651391.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210507104034573.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210506171605402.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210506171821029.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210506174911588.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210506175509684.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210506180311779.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210510154200362.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210510154644069.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210510155439959.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210506181540998.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210508182041201.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210508182245495.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210508183337555.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210510111459753.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510150739879.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508171436532.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510151806991.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510152443179.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507181336131.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508110704762.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508111929617.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508172504215.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508173420372.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210507174147586.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210518145852473.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210518150202423.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507155029466.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507155526630.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507160650959.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507160904453.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507162858974.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510164649320.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510165012773.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510180352849.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511103159148.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511103709556.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511142758330.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511143702801.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511144017535.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210511160143841.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210512100843378.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210512101808226.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210513150802159.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210513151043853.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210512143842725.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210512144554468.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210512145853322.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210512165247797.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210512165617827.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210512171659053.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210512174853186.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210513111409102.png">
<meta property="og:image" content="c:/Users/donky16/Desktop/tmp/http/Markdown/image-20210513152431882.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210513153208424.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210517153729144.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210517160156654.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210517161242711.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210517164903160.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210517165215792.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210517165451682.png">
<meta property="og:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210517170536557.png">
<meta property="og:updated_time" content="2022-03-28T11:32:16.400Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从RFC规范看如何绕过waf上传表单">
<meta name="twitter:description" content="文章首发于安全客，分上下两篇，此为完整版本">
<meta name="twitter:image" content="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/image-20210506165651391.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/"/>





  <title>从RFC规范看如何绕过waf上传表单 | donky16</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">donky16</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://donky.cn/2022/03/28/从RFC规范看如何绕过waf上传表单/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="donky16">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="donky16">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">从RFC规范看如何绕过waf上传表单</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-03-28T19:25:23+08:00">
                2022-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/协议安全/" itemprop="url" rel="index">
                    <span itemprop="name">协议安全</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/协议安全/WAF/" itemprop="url" rel="index">
                    <span itemprop="name">WAF</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>文章首发于安全客，分上下两篇，此为完整版本<a id="more"></a></p>
<h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>传统waf以规则匹配为主，如果只是无差别的使用规则匹配整个数据包，当规则数量逐渐变多，会造成更多性能损耗，当然还会发生误报情况。为了能够解决这些问题，需要对数据包进行解析，进行精准位置的规则匹配。</p>
<p>正常业务中上传表单使用普遍，不仅能够传参，还可以进行文件的上传，当然这也是一个很好的攻击点，waf想要能够精准拦截针对表单的攻击，需要进行multipart/form-data格式数据的解析，并针对每个部分，如参数值，文件名，文件内容进行针对性的规则匹配拦截。</p>
<p>虽然RFC规范了multipart/form-data相关的格式与解析，但是由于不同后端程序的实现机制不同，而且RFC相关文档也会进行增加补充，最终导致解析方式各不相同。对于waf来说，很难做到对各个后端程序进行定制化解析，尤其是云waf更加无法实现。</p>
<p>所以本文主要讨论，利用waf和后端程序对multipart/form-data的解析差异，造成对waf的bypass。</p>
<p>multipart/form-data相关RFC: </p>
<ul>
<li>基于表单的文件上传: <a href="https://www.ietf.org/rfc/rfc1867.txt" target="_blank" rel="noopener">RFC1867</a></li>
<li>multipart/form-data: <a href="https://tools.ietf.org/html/rfc7578" target="_blank" rel="noopener">RFC7578</a></li>
<li>Multipart Media Type: <a href="https://tools.ietf.org/html/rfc2046#section-5.1" target="_blank" rel="noopener">RFC2046#section-5.1</a></li>
</ul>
<h2 id="解析环境"><a href="#解析环境" class="headerlink" title="解析环境"></a>解析环境</h2><p>Flask/Werkzeug解析环境：docker/<a href="https://github.com/postmanlabs/httpbin" target="_blank" rel="noopener">httpbin</a></p>
<p>Java解析环境：Windows10 pro 20H2/Tomcat9.0.35/jdk1.8.0_271/commons-fileupload</p>
<p>Java输出代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">String result = <span class="string">""</span>;</span><br><span class="line">DiskFileItemFactory factoy = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">ServletFileUpload sfu = <span class="keyword">new</span> ServletFileUpload(factoy);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    List&lt;FileItem&gt; list = sfu.parseRequest(req);</span><br><span class="line">    <span class="keyword">for</span> (FileItem fileItem : list) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fileItem.getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result += fileItem.getFieldName() + <span class="string">": "</span> + fileItem.getString() + <span class="string">"\n"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result += <span class="string">"filename: "</span> + fileItem.getName() + <span class="string">"  "</span> + fileItem.getFieldName() + <span class="string">": "</span> + fileItem.getString() + <span class="string">"\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileUploadException e) &#123;</span><br><span class="line">    <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PHP解析环境：Ubuntu18.04/Apache2.4.29/PHP7.2.24</p>
<p>PHP输出代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump($_FILES);</span><br><span class="line">var_dump($_POST);</span><br></pre></td></tr></table></figure>
<h2 id="基础格式"><a href="#基础格式" class="headerlink" title="基础格式"></a>基础格式</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/post</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: www.example.com:8081</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span>: */*</span><br><span class="line"><span class="attribute">Accept-Language</span>: en</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=I_am_a_boundary</span><br><span class="line"><span class="attribute">Content-Length</span>: 303</span><br><span class="line"></span><br><span class="line">--I_am_a_boundary</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="name"; filename="file.jsp"</span><br><span class="line"><span class="attribute">Content-Type</span>: text/plain;charset=UTF-8</span><br><span class="line"></span><br><span class="line"><span class="attribute">This_is_file_content.</span></span><br><span class="line"><span class="attribute">--I_am_a_boundary</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="key";</span><br><span class="line"><span class="attribute">Content-Type</span>: text/plain;charset=UTF-8</span><br><span class="line"></span><br><span class="line"><span class="attribute">This_is_a_value.</span></span><br><span class="line"><span class="attribute">--I_am_a_boundary--</span></span><br></pre></td></tr></table></figure>
<p>此表单数据含有一个文件，name为name，filename为file.jsp，file_content为This_is_file_content.，还有一个非文件的参数，其name为key，value为This_is_a_value.。</p>
<p>httpbin解析结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;, </span><br><span class="line">  <span class="attr">"data"</span>: <span class="string">""</span>, </span><br><span class="line">  <span class="attr">"files"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"This_is_file_content."</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"form"</span>: &#123;</span><br><span class="line">    <span class="attr">"key"</span>: <span class="string">"This_is_a_value."</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"*/*"</span>, </span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"deflate, identity;q=0.5"</span>, </span><br><span class="line">    <span class="attr">"Accept-Language"</span>: <span class="string">"en"</span>, </span><br><span class="line">    <span class="attr">"Content-Length"</span>: <span class="string">"303"</span>, </span><br><span class="line">    <span class="attr">"Content-Type"</span>: <span class="string">"multipart/form-data; boundary=I_am_a_boundary"</span>, </span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"www.example.com:8081"</span>, </span><br><span class="line">    <span class="attr">"Route-Hop"</span>: <span class="string">"1"</span>, </span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36"</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">"json"</span>: <span class="literal">null</span>, </span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"10.1.1.1"</span>, </span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://www.example.com:8081/post"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="详细解析"><a href="#详细解析" class="headerlink" title="详细解析"></a>详细解析</h2><h3 id="1-Content-Type"><a href="#1-Content-Type" class="headerlink" title="1. Content-Type"></a>1. Content-Type</h3><p><code>Content-Type: multipart/form-data; boundary=I_am_a_boundary</code></p>
<p>对于上传表单类型，Content-Type必须为<code>multipart/form-data</code>，并且后面要跟一个边界参数键值对（boundary），在表单中分割各部分使用。</p>
<p>倘若<code>multipart/form-data</code>编写错误，或者不写<code>boundary</code>，那么后端将无法准确解析这个表单的每个具体内容。</p>
<p><img src="image-20210506165651391.png" alt="image-20210506165651391"></p>
<h3 id="2-Boundary"><a href="#2-Boundary" class="headerlink" title="2. Boundary"></a>2. Boundary</h3><p>boundary: <a href="https://tools.ietf.org/html/rfc2046#section-5.1" target="_blank" rel="noopener">RFC2046</a></p>
<p>boundary需要按照以下BNF巴科斯范式</p>
<p> <img src="image-20210507104034573.png" alt="image-20210507104034573"></p>
<p>简单解释就是，boundary不能以空格结束，但是其他位置都可以为空格，而且字符长度在1-70之间，此规定语法适用于所有multipart类型，当然并不是所有程序都按照这种规定来进行multipart的解析。</p>
<p>从前面介绍的multipart基础格式可以看出来，真正作为表单各部分之间分隔边界的不仅是Content-Type中boundary的值，真正的边界是由<code>--</code>和<code>boundary</code>的值和末尾的<code>CRLF</code>组成的分隔行，当然为了能够准确解析表单各个部分的数据，需要保证分隔行不会出现在正常的表单中的文件内容或者参数值中，所以RFC也建议使用特定的算法来生成boundary值。</p>
<p>flask解析结果</p>
<p><img src="image-20210506171605402.png" alt="image-20210506171605402"></p>
<p>这里需要注意两个点，第一，最终表单数据最后一个分隔边界，要以<code>--</code>结尾。第二，RFC规定原文为<img src="image-20210506171821029.png" alt="image-20210506171821029"></p>
<p>也就是说，整体的分隔边界可以含有<code>optional linear whitespace</code>。</p>
<h4 id="空格"><a href="#空格" class="headerlink" title="空格"></a>空格</h4><p>注：本文使用空格的地方<code>[\r\n\t\f\v ]</code>都可以代替使用，文中只是介绍了使用空格的结果，大家可以测试其他的，waf或者后端程序在解析<code>\n</code>时，会产生很多不同结果，感兴趣可自行测试。</p>
<p>首先使用boundary的值后面加空格进行测试，flask和php都能够正常的解析出表单内容。</p>
<p>php解析结果</p>
<p><img src="image-20210506174911588.png" alt="image-20210506174911588"></p>
<p>虽然boundary的值后面加了空格，但是在作为分隔行的时候并没有空格也可以正常解析，但是经测试发现如果按照RFC规定那样直接在分隔行中加入空格，效果就会不一样。</p>
<p><img src="image-20210506175509684.png" alt="image-20210506175509684"></p>
<p>对于flask来说是按照了RFC规定实现，无论Content-Type中boundary的值后面是不加空格还是加任意空格，在表单中非结束分隔行里都可以随意加空格，都不影响表单数据解析，但是需要注意的就是，在最后的结束分隔行中，加空格会导致解析失败。</p>
<p>很有意思的是php解析过程中，在非结束分隔行中不能增加空格，而在结束分隔行中增加空格，却不会影响解析。</p>
<p><img src="image-20210506180311779.png" alt="image-20210506180311779"></p>
<p>可以看到，加了空格的分隔行内的文件内容数据没有被正确解析，而没加空格的非文件参数被解析成功，而且结束分隔行中也添加了空格。</p>
<p>测试的时候偶然发现在如果在<code>multipart/form-data</code>和<code>;</code>之间加空格，如<code>Content-Type: multipart/form-data ; boundary=&quot;I_am_a_boundary&quot;</code>，flask会造成解析失败，php解析正常。</p>
<p><img src="image-20210510154200362.png" alt="image-20210510154200362"></p>
<p>正常来说，通过正则进行匹配解析的flask应该不会这样，具体实现在<code>werkzeug/http.py:L406</code>。</p>
<p><img src="image-20210510154644069.png" alt="image-20210510154644069"></p>
<p>简单来说就是将<code>Content-Type: multipart/form-data ; boundary=&quot;I_am_a_boundary&quot;</code>进行正则匹配，然后将第一组匹配结果当作mimetype，第二组作为rest，由后面处理boundary取值，看下这个正则。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_option_header_start_mime_type = re.compile(<span class="string">r",\s*([^;,\s]+)([;,]\s*.+)?"</span>)</span><br></pre></td></tr></table></figure>
<p>为了看着美观，使用regex101看下。</p>
<p><img src="image-20210510155439959.png" alt="image-20210510155439959"> </p>
<p>很明显，由于第一组匹配非空字符，所以到空格处就停了，但是第二组必须是<code>[;,]</code>开头，导致第二组匹配值为空，无法获取boundary，最终解析失败。</p>
<h4 id="双引号"><a href="#双引号" class="headerlink" title="双引号"></a>双引号</h4><p>boundary的值是支持用双引号进行编写的，就像是表单中的参数值一样，这样在写分隔行的时候，就可以将双引号内的内容作为boundary的值，php和flask都支持这种写法。使用单引号是无法达到效果的，这也是符合上文提到的BNF巴科斯范式的<code>bcharsnospace</code>的。</p>
<p><img src="image-20210506181540998.png" alt="image-20210506181540998"></p>
<p>测试一下让重复多个双引号，或者含有未闭合的双引号或者双引号前后增加其他字符会发生什么。</p>
<p><code>Content-Type: multipart/form-data; boundary=a&quot;I_am_a_boundary&quot;</code></p>
<p><code>Content-Type: multipart/form-data; boundary= &quot;I_am_a_boundary&quot;</code></p>
<p><code>Content-Type: multipart/form-data; boundary=   &quot;I_am_a_boundary&quot;a</code></p>
<p><code>Content-Type: multipart/form-data; boundary=I_am_a_boundary&quot;</code></p>
<p><code>Content-Type: multipart/form-data; boundary=&quot;I_am_a_boundary</code></p>
<p><code>Content-Type: multipart/form-data; boundary=&quot;I_am_a_boundary&quot;aa&quot;</code></p>
<p><code>Content-Type: multipart/form-data; boundary=&quot;&quot;I_am_a_boundary&quot;</code></p>
<p>对于php来说相对简单，因为只要出现第一个字符不是双引号，就算是空格，都会将之作为boundary的一部分，所以前四种解析类似，当第一个字符为双引号时，会找与之对应的闭合的双引号，如果找到了，那么就会忽略之后的内容直接取双引号内内容作为boundary的值。</p>
<p><img src="image-20210508182041201.png" alt="image-20210508182041201"></p>
<p>然而如果没有找到闭合双引号，就会导致boundary取值失败，无法解析multipart/form-data。</p>
<p><img src="image-20210508182245495.png" alt="image-20210508182245495"></p>
<p>当然对于最后一种情况，会取一个空的boundary值，我也以为会解析失败，但是很搞笑的是，竟然boundary值为空，php也可以正常解析，当然也可以直接写成<code>Content-Type: multipart/form-data; boundary=</code>。</p>
<p><img src="image-20210508183337555.png" alt="image-20210508183337555"></p>
<p>大多数waf应该会认为这是一个不符合规范的boundary，从而导致解析multipart/form-data失败，所以这种绕过waf的方式显得更加粗暴。</p>
<p>对于flask来说，可以看下解析boundary的正则<code>werkzeug/http.py:L79</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">_option_header_piece_re = re.compile(</span><br><span class="line">    <span class="string">r"""</span></span><br><span class="line"><span class="string">    ;\s*,?\s*  # newlines were replaced with commas</span></span><br><span class="line"><span class="string">    (?P&lt;key&gt;</span></span><br><span class="line"><span class="string">        "[^"\\]*(?:\\.[^"\\]*)*"  # quoted string</span></span><br><span class="line"><span class="string">    |</span></span><br><span class="line"><span class="string">        [^\s;,=*]+  # token</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    (?:\*(?P&lt;count&gt;\d+))?  # *1, optional continuation index</span></span><br><span class="line"><span class="string">    \s*</span></span><br><span class="line"><span class="string">    (?:  # optionally followed by =value</span></span><br><span class="line"><span class="string">        (?:  # equals sign, possibly with encoding</span></span><br><span class="line"><span class="string">            \*\s*=\s*  # * indicates extended notation</span></span><br><span class="line"><span class="string">            (?:  # optional encoding</span></span><br><span class="line"><span class="string">                (?P&lt;encoding&gt;[^\s]+?)</span></span><br><span class="line"><span class="string">                '(?P&lt;language&gt;[^\s]*?)'</span></span><br><span class="line"><span class="string">            )?</span></span><br><span class="line"><span class="string">        |</span></span><br><span class="line"><span class="string">            =\s*  # basic notation</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">        (?P&lt;value&gt;</span></span><br><span class="line"><span class="string">            "[^"\\]*(?:\\.[^"\\]*)*"  # quoted string</span></span><br><span class="line"><span class="string">        |</span></span><br><span class="line"><span class="string">            [^;,]+  # token</span></span><br><span class="line"><span class="string">        )?</span></span><br><span class="line"><span class="string">    )?</span></span><br><span class="line"><span class="string">    \s*</span></span><br><span class="line"><span class="string">    """</span>,</span><br></pre></td></tr></table></figure>
<p>这个正则可以解释本文的大多数flask解析结果产生的原因，这里看到flask对于boundary两边的空格是做了处理的，对于双引号的处理，都会取第一对双引号内的内容作为boundary的值，对于非闭合的双引号，会处理成<code>token</code>形式，将双引号作为boundary的一部分，并不会像php一样解析boundary失败。</p>
<p><img src="image-20210510111459753.png" alt="image-20210510111459753"></p>
<p>从上面正则也能看出，对于最后一种Content-Type的情况，flask也会取空值作为boundary的值，但是这不会同过flask对boundary的正则验证，导致boundary取值失败，无法解析，下文会提及到。</p>
<h4 id="转义符号"><a href="#转义符号" class="headerlink" title="转义符号"></a>转义符号</h4><p>以flask的正则中<code>quoted string</code>和<code>token</code>作为区分是否boundary为双引号内取值，测试两种转义符的位置会怎样影响解析。</p>
<ul>
<li><p><code>\</code>在<code>token</code>中</p>
<p><code>Content-Type: multipart/form-data; boundary=I_am_a\&quot;_boundary</code></p>
<p>这种形式的boundary，flask和php都会将<code>\</code>认定为一个字符，并不具有转义作用，并将整体的<code>I_am_a\&quot;_boundary</code>内容做作为boundary的值。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510150739879.png" alt="image-20210510150739879"></p>
</li>
<li><p><code>\</code>在<code>quoted string</code>中</p>
<p><code>Content-Type: multipart/form-data; boundary=&quot;I_am_a\&quot;_boundary&quot;</code></p>
<p>对于flask来说，在双引号的问题上，<code>werkzeug/http.py:L431</code>中调用一个处理函数，就是取双引号之间的内容作为boundary的值。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508171436532.png" alt="image-20210508171436532"></p>
<p>可以看到，在取完boundary值之后还做了一个<code>value.replace(&quot;\\\\&quot;, &quot;\\&quot;).replace(&#39;\\&quot;&#39;, &#39;&quot;&#39;)</code>的操作，将转义符认定为具有转义的作用，而不是单单一个字符，所以最终boundary的值是<code>I_am_a&quot;_boundary</code>。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510151806991.png" alt="image-20210510151806991"></p>
<p>对于php来说，依旧和<code>token</code>类型的boundary处理机制一样，认定<code>\</code>只是一个字符，不具有转义作用，所以按照上文<code>双引号</code>中提到的，由于遇到第二个双引号就会直接闭合双引号，忽略后面内容，最终php会取<code>I_am_a\</code>作为boundary的值。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510152443179.png" alt="image-20210510152443179"></p>
</li>
</ul>
<h4 id="空格-amp-双引号"><a href="#空格-amp-双引号" class="headerlink" title="空格 &amp; 双引号"></a>空格 &amp; 双引号</h4><p>上文提到使用空格对解析的影响，既然可以使用双引号来指定boundary的值，那么如果在双引号外或者内加入空格，后端会如何解析呢？</p>
<ul>
<li><p>双引号外</p>
<p>对于flask来说，依旧和普通不加双引号的解析一致，会忽略双引号外（两边）的空格，直接取双引号内的内容作为boundary的值，php对于双引号后面有空格时，处理机制和flask一致，但是当双引号前面有空格时，会无法正常解析表单数据内容。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507181336131.png" alt="image-20210507181336131"></p>
<p>解析会和不带双引号的实现一致，此时php会将前面的空格和后面的双引号和双引号的内容作为一个整体，将之作为boundary的值，当然这虽然符合RFC规定的boundary可以以空格开头，但是把双引号当作boundary的一部分并不符合。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508110704762.png" alt="image-20210508110704762"></p>
</li>
<li><p>双引号内</p>
<p>此时php会取双引号内的所有内容（非双引号）作为boundary的值，无论是以任意空格开头还是结束，其分隔行中boundary前后的空格数，要与Content-Type中双引号内boundary前后的空格个数一致，否则解析失败。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508111929617.png" alt="image-20210508111929617"></p>
<p>值得注意的是，flask解析的时候，如果双引号内的boundary值以空格开始，那么在分隔行中类似php只要空格个数一致，就可以成功解析，但是如果双引号内的boundary的值以空格结束，无论空格个数是否一致，都无法正常解析。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508172504215.png" alt="image-20210508172504215">想知道为什么出现这种状况，只能看下werkzeug是如何实现的，flask对boundary的验证可以在<code>werkzeug/formparser.py:L46</code>看到。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#: a regular expression for multipart boundaries</span></span><br><span class="line">_multipart_boundary_re = re.compile(<span class="string">"^[ -~]&#123;0,200&#125;[!-~]$"</span>)</span><br></pre></td></tr></table></figure>
<p>这个正则是来验证boundary有效性的，比较符合RFC规定的，只不过在长度上限制更小，可以是空格开头，不能以空格结尾，但是用的不是全匹配，所以以空格结尾也会通过验证。</p>
<p>上图使用<code>boundary= &quot; I_am_a_boundary &quot;</code>，所以boundary的值为<code>&quot; I_am_a_boundary &quot;</code>双引号内的内容，而且这个值也会通过boundary正则的验证，最终还是解析失败了，很是是奇怪。上文<code>空格</code>中提到，对于flask来说，在分隔行中boundary后可以加任意空格不影响最终的解析的。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210508173420372.png" alt="image-20210508173420372"></p>
<p>原因是解析multipart/form-data具体内容时，为了寻找分割行，将每一行数据都进行了一个<code>line.strip()</code>操作，这样会把CRLF去除，当然会把结尾的所有空格也给strip掉，所以当boundary不以空格结尾时，在分隔行中可以随意在结尾加空格。但是这也会导致一个问题，当不按照RFC规定，用空格结尾作为boundary值，虽然过了flask的boundary正则验证，但是在解析body时，却将结尾的空格都strip掉，导致在body中分隔行经过处理之后变为了<code>-- I_am_a_boundary</code>，这与Content-Type中获取的boundary值（结尾含有空格）并不一致，导致找不到分隔行，解析全部失败。</p>
</li>
</ul>
<h4 id="结束分隔行"><a href="#结束分隔行" class="headerlink" title="结束分隔行"></a>结束分隔行</h4><p>在上文<code>空格</code>内容中提到，php在结束分割行中的boundary后面加空格并不会影响最终的解析，其实并不是空格的问题，经测试发现，其实php根本就没把结束分隔行当回事。</p>
<p><img src="image-20210507174147586.png" alt="image-20210507174147586"></p>
<p>可以看到，没有结束分隔行，php会根据每一分隔行来分隔各个表单部分，并根据Content-Length来进行取表单最后一部分的内容的值，然而这是极不尊重RFC规定的，一般waf会将这种没有结束分隔行的视为错误的multipart/form-data格式，从而导致整体body解析失败，那么waf可以被绕过。</p>
<p>上文提到flask会对multipart/form-data的每一行内容进行strip操作，但是由于结束分隔行需要以<code>--</code>结尾，所以在strip的过程中只会将<code>CRLF</code>strip掉，但是在解析boundary的时候，boundary是不能以空格为结尾的，最终会导致结束分隔行是严谨的<code>--BOUNDARY--CRLF</code>，当然如果使用双引号使boundary以空格结尾，那么结束分隔行是可以正确解析的，但是非结束分隔行无法解析还是会导致整体解析失败。</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>从flask的代码能够看出来，支持参数名的<code>quoted string</code>形式，就是参数名在双引号内。</p>
<p><img src="image-20210518145852473.png" alt="image-20210518145852473"></p>
<p>而对于Java来说，支持参数名的大小写不敏感的写法。</p>
<p><img src="image-20210518150202423.png" alt="image-20210518150202423"></p>
<h3 id="3-Content-Disposition"><a href="#3-Content-Disposition" class="headerlink" title="3. Content-Disposition"></a>3. Content-Disposition</h3><p>对于multipart/form-data类型的数据，通过分隔行分隔的每一部分都必须含有Content-Dispostion，其类型为form-data，并且必须含有一个name参数，形如<code>Content-Disposition: form-data; name=&quot;name&quot;</code>，如果这部分是文件类型，可以在后面加一个filename参数，当然filename参数是可选的。</p>
<h4 id="空格-1"><a href="#空格-1" class="headerlink" title="空格"></a>空格</h4><p>经常和waf打交道的都知道，随便一个空格，可能就会发生奇效。对于Content-Disposition参数，测试在四个位置加任意的空格。</p>
<ul>
<li><p>原本有空格的位置</p>
<p><code>Content-Disposition: form-data;    name=&quot;key1&quot;; filename=&quot;file.php&quot;</code></p>
<p><code>Content-Disposition: form-data;   name=&quot;key1&quot;   ;   filename=&quot;file.php&quot;</code></p>
<p><code>Content-Disposition:    form-data;    name=&quot;key1&quot;   ;   filename=&quot;file.php&quot;</code></p>
<p><code>Content-Disposition: form-data  ;     name=&quot;key1&quot;   ;   filename=&quot;file.php&quot;</code></p>
<p>前三种类型，php和flask解析都是准确的。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507155029466.png" alt="image-20210507155029466"></p>
<p>但是第四种对于<code>Content-Disposition: form-data   ;</code>来说，php解析准确，认为其是正常的multipart/form-data数据，然而flask解析失败了，并且直接返回了500（：</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507155526630.png" alt="image-20210507155526630"></p>
<p>这里flask处理Content-Disposition的方式是和request_header中Content-Type是一致的，经过了<code>r&quot;,\s*([^;,\s]+)([;,]\s*.+)?&quot;</code>匹配，由于空格导致后面的name和filename无法解析，只不过这种情况会返回500。对于后续的name和filename得解析也是和request_header中Content-Type一致，后面匹配中的group作为rest进行后续的正则匹配，匹配用到的正则，是上文第2部分（Boundary）双引号中的<code>_option_header_piece_re</code>。</p>
</li>
<li><p>参数名和等于号之间</p>
<p><code>Content-Disposition: form-data; name  =&quot;key1&quot;; filename=&quot;file.php&quot;</code></p>
<p><code>Content-Disposition: form-data; name=&quot;key1&quot;; filename   =&quot;file.php&quot;</code></p>
<p>flask正常解析</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507160650959.png" alt="image-20210507160650959"></p>
<p>php解析失败，不仅第一部分数据无法解析，第二部分非文件参数也解析失败，可见php解析会将<code>name=</code>/<code>filename=</code>作为关键字匹配，当发现<code>name=</code>和<code>filename=</code>都不存在时，直接不再解析了，这与boundary的解析是不一样的，使用<code>Content-Type: multipart/form-data; boundary =I_am_a_boundary</code>一样可以正常解析处boundary的值。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507160904453.png" alt="image-20210507160904453"></p>
<p>如果我们不在name和等于号之间加空格，只在filename和等于号之间加空格，形如<code>Content-Disposition: form-data; name=&quot;key1&quot;; filename  =&quot;file.txt&quot;</code>，那么php会将这种解析会非文件参数。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210507162858974.png" alt="image-20210507162858974"></p>
<p>如果waf支持这种多余空格形式的写法，那么将会把这种解析为文件类型，造成解析上的差异，waf错把非文件参数当作文件，那么可能绕过waf的部分规则。</p>
</li>
<li><p>参数值和等于号之间</p>
<p><code>Content-Disposition: form-data; name=  &quot;key1&quot;; filename=  &quot;file_name&quot;</code></p>
<p>php和flask解析正常。</p>
</li>
<li><p>参数值中</p>
<p>这个没啥注意的，flask会按照准确的name解析。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510164649320.png" alt="image-20210510164649320"></p>
<p>php会忽略开头的空格，并把非开头空格转化为<code>_</code>，具体原因可以看<a href="https://www.php.net/manual/zh/language.variables.external.php" target="_blank" rel="noopener">php-variables</a>。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510165012773.png" alt="image-20210510165012773"></p>
</li>
</ul>
<h4 id="重复参数"><a href="#重复参数" class="headerlink" title="重复参数"></a>重复参数</h4><ul>
<li><p>重复name/filename参数名</p>
<p>php和flask都会取最后一个name/filename，从flask代码来看，存储参数使用了字典，由于具有相同的key=name，所以最后在解析的时候，遇到相同key的参数，会进行参数值的覆盖。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210510180352849.png" alt="image-20210510180352849"></p>
<p>这种重复参数名的方式，在下文中将结合其他方式进行绕过waf。</p>
</li>
<li><p>重复name/filename参数名和参数值</p>
<p>接着尝试重复整个form-data的一部分，构造这样一个数据包进行测试。</p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">--I_am_a_boundary</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"key3"</span>; filename=<span class="string">"file_name.asp"</span></span><br><span class="line">Content-Type: text/plain;charset=UTF<span class="number">-8</span></span><br><span class="line"></span><br><span class="line">This_is_file_content.</span><br><span class="line">--I_am_a_boundary</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"key3"</span>; filename=<span class="string">"file_name.jsp"</span></span><br><span class="line">Content-Type: text/plain;charset=UTF<span class="number">-8</span></span><br><span class="line"></span><br><span class="line">This_is_file2_content.</span><br><span class="line">--I_am_a_boundary</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"key5"</span>;</span><br><span class="line">Content-Type: text/plain;charset=UTF<span class="number">-8</span></span><br><span class="line"></span><br><span class="line">aaaaaaaaaaaa</span><br><span class="line">--I_am_a_boundary</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"key5"</span>;</span><br><span class="line">Content-Type: text/plain;charset=UTF<span class="number">-8</span></span><br><span class="line"></span><br><span class="line">bbbbbbbbbbbb</span><br><span class="line">--I_am_a_boundary--</span><br></pre></td></tr></table></figure>
<p>对于php来说，和在同一个Content-Disposition中重复name/filename一致，会选取相同name部分中最后一部分。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511103159148.png" alt="image-20210511103159148"></p>
<p>对于flask来说，带有filename的，会取第一部分，而且相同name的非文件参数，会将两个取值作为一个列表解析。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511103709556.png" alt="image-20210511103709556"></p>
<p>其实这里是httpbin处理后的结果，为了准确看到flask解析结果，需要直接查看<code>request.form/request.files</code>。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511142758330.png" alt="image-20210511142758330"></p>
<p>使用的是<code>ImmutableMultiDict</code>，在<code>werkzeug/datastructures.py</code>中定义，可以看到，最终form和files都是把所有multipart数据都获取了，即使具有相同的key。如果我们使用常用的<code>keys()/values()/item()</code>函数，都会因为相同key，而只能取到第一个key的值，想获取相同key的所有取值，需要使用<code>ImmutableMultiDict.to_dict()</code>方法，并设置参数<code>flat=True</code>。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511143702801.png" alt="image-20210511143702801"></p>
<p>httpbin就是在<a href="https://github.com/postmanlabs/httpbin/blob/f8ec666b4d1b654e4ff6aedd356f510dcac09f83/httpbin/helpers.py#L142" target="_blank" rel="noopener">处理</a>request.form时，多加了这种处理，导致最后看到两个取值的列表，但是在request.files处理时没有进行<code>to_dict</code>。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210511144017535.png" alt="image-20210511144017535"></p>
<p>由此可见，不同的后端程序，实现起来可能会不一样，如果waf在实现时，并没有将所有key重复的数据都解析出来，并且进入waf规则匹配，那么使用重复的key，也会成为很好的绕过waf的方式。</p>
</li>
</ul>
<h4 id="引号"><a href="#引号" class="headerlink" title="引号"></a>引号</h4><p>上文提到，<code>_option_header_piece_re</code>这个正则在flask中也会用来解析Content-Disposition，所以对于name/filename的取值，和boundary取值机制是一样的，加了双引号是<code>quoted string</code>，没有双引号的是<code>token</code>。</p>
<p>所以主要分析php是如何处理的，首先php在处理boundary时，如果空格开头，那么空格将作为boundary的一部分即使空格后存在正常的双引号闭合的boundary。但是在Content-Disposition中，双引号外的空格是可以被忽略的，当然不使用双引号，参数值两边的空格也会被忽略。</p>
<p><img src="image-20210511160143841.png" alt="image-20210511160143841"></p>
<p>此小段标题<code>引号</code>，并没有像上一大段一样使用<code>双引号</code>，是因为php不仅支持双引号取值，也支持单引号取值，这很php。</p>
<p><img src="image-20210512100843378.png" alt="image-20210512100843378"></p>
<p>flask肯定是不支持单引号的，上面的正则能看出来，单引号会被当作参数值的一部分，这里看了下Java的<code>commons-fileupload</code>v1.2的实现<code>org.apache.commons.fileupload.ParameterParser.java:L76</code>，在解析参数值的时候也是不支持单引号的。</p>
<p><img src="image-20210512101808226.png" alt="image-20210512101808226"></p>
<p>所以如果waf在multipart解析中是不支持参数值用单引号取值的，对于php而言，出现这种payload就可以导致waf解析错误。</p>
<p><code>Content-Disposition: form-data; name=&#39;key3; filename=&#39;file_name.txt; name=&#39;key3&#39;</code></p>
<p>支持单引号的会将之解析为<code>{&quot;name&quot;: &quot;key3&quot;}</code>，并没有filename参数，视为非文件参数</p>
<p>不支持单引号的会将之解析为<code>{&quot;name&quot;: &quot;&#39;key3&#39;&quot;, &quot;filename&quot;: &quot;&#39;file_name.txt&quot;}</code>，视为文件参数，将之后参数值视为文件内容。</p>
<p>这种waf和后端处理程序解析的不一致可能会导致waf被绕过。</p>
<p>此时，还有一个引号的问题没有解决，就是如果出现多余的引号会发生什么，形如<code>Content-Disposition: form-data; name=&quot;key3&quot;a&quot;; filename=&quot;file_name;txt&quot;</code>，上文在boundary的解析中已经看到了结果，name会取<code>key3</code>，并忽略之后的内容，即使含有双引号，那么后面的filename内容还能正确解析吗？正好看看flask使用正则和Java/php使用字符解析带来的一些差异。</p>
<p>看一下flask的具体实现<code>werkzeug/http.py:L402</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">result = []</span><br><span class="line">value = <span class="string">","</span> + value.replace(<span class="string">"\n"</span>, <span class="string">","</span>)	<span class="comment"># ',form-data; name="key3"aaaa"; filename="file_name.txt"'</span></span><br><span class="line"><span class="keyword">while</span> value:</span><br><span class="line">    match = _option_header_start_mime_type.match(value)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> match:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    result.append(match.group(<span class="number">1</span>))  <span class="comment"># mimetype</span></span><br><span class="line">    options = &#123;&#125;</span><br><span class="line">    <span class="comment"># Parse options</span></span><br><span class="line">    rest = match.group(<span class="number">2</span>)	<span class="comment"># '; name="key3"aaaa"; filename="file_name.txt"'</span></span><br><span class="line">    continued_encoding = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">while</span> rest:</span><br><span class="line">        optmatch = _option_header_piece_re.match(rest)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> optmatch:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        option, count, encoding, language, option_value = optmatch.groups()	<span class="comment"># option_value: "key3"</span></span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        ... <span class="comment"># 省略</span></span><br><span class="line">        rest = rest[optmatch.end() :]</span><br><span class="line">    result.append(options)</span><br></pre></td></tr></table></figure>
<p>使用<code>_option_header_piece_re</code>匹配到之后，会继续从下一个字符开始继续进入正则匹配，所以第二次进入正则时，rest为<code>aaaa&quot;; filename=&quot;file_name.txt&quot;</code>，以a开头就无法匹配中正则了，直接退出，导致filename解析失败，并且name取key3。</p>
<p><img src="image-20210513150802159.png" alt="image-20210513150802159"></p>
<p>Java的代码在上面已经贴出，其中的<code>terminators=&quot;;&quot;</code>，也就是说当出现双引号时，会忽略<code>;</code>，但是当找到闭合双引号时，取值没有结束，会继续寻找<code>;</code>，这就导致会一直取到闭合双引号外的<code>;</code>才会停止，这和php是不一致的，php虽然后面多余的双引号会影响后续filename取值，但是会在第一次出现闭合双引号时取值结束。</p>
<p><img src="image-20210513151043853.png" alt="image-20210513151043853"></p>
<p>对于flask/php来说，如果waf解析方式和后端不相同，也可能会错误判断文件和非文件参数，但是Java后端很难使用，因为对于name的取值会导致后端无法正确获取。但是这个取值特性依旧有用，下文<code>文件扩展名</code>将进行介绍。</p>
<h4 id="转义符号-1"><a href="#转义符号-1" class="headerlink" title="转义符号"></a>转义符号</h4><p>php和flask都支持参数值中含有转移符号，从上面的<code>_option_header_piece_re</code>正则可以看出，和boundary取值一致，flask在<code>quoted string</code>类型的参数值中的转义符具有转义作用，在<code>token</code>类型中只是一个字符<code>\</code>，不具有转义作用。</p>
<p><img src="image-20210512143842725.png" alt="image-20210512143842725"></p>
<p>php虽然在<code>token</code>类型中，解析和对boundary解析一致，转义符号具有转义作用，但是在解析<code>quoted string</code>类型时解析方式和boundary竟然不一样了，解析boundary时，转义符为一个<code>\</code>字符不具有转义作用，所以<code>boundary=&quot;aa\&quot;bbb&quot;</code>会被解析为<code>aa\</code>，而在Content-Disposition中，转义符号具有转义作用。</p>
<p><img src="image-20210512144554468.png" alt="image-20210512144554468"></p>
<p>和上文提到的php解析单引号的方式一样，存在这么一种payload</p>
<p><code>Content-Disposition: form-data; name=&quot;key3\&quot;; filename=&quot;file_name.txt; name=&quot;key3&quot;</code></p>
<p><img src="image-20210512145853322.png" alt="image-20210512145853322"></p>
<p>flask/php将之解析为非文件参数，并且根据多个重复的name/filename解析机制，最终解析结果<code>{&quot;name&quot;: &quot;key3&quot;}</code></p>
<p>如果waf并不支持转义符号的解析，只是简单的字符匹配双引号闭合，那么解析结果为<code>{&quot;name&quot;: &quot;key3\\&quot;, &quot;filename&quot;: &quot;\&quot;file_name.txt&quot;}</code>，视为文件参数，将之后参数值视为文件内容，造成解析差异，导致waf可能被绕过。</p>
<p>上文提到php可以使用单引号取值，在单引号中增加转义符的解析方式会和双引号不同，具体可参考<a href="https://www.cnblogs.com/youxin/archive/2012/02/13/2348551.html" target="_blank" rel="noopener">php单引号和双引号的区别与用法</a>。</p>
<h4 id="文件扩展名"><a href="#文件扩展名" class="headerlink" title="文件扩展名"></a>文件扩展名</h4><p>前文主要提出一些mutlipart整体上的waf绕过，在源站后端解析正常的情况下让waf解析失败不进入规则匹配，或者waf解析与后端有差异，判断是否为文件失败，导致规则无法匹配，或者filename参数根本没有进入waf的规则匹配。无论是在CTF比赛中还是在实际渗透测试中，如何绕过文件扩展名是大家很关注的一个点，所以这一段内容主要介绍，在waf解析到filename参数的情况下，从协议和后端解析的层面如何绕过文件扩展名。</p>
<p>其实这种绕过就一个思路，举个简单的例子<code>filename=&quot;file_name.php&quot;</code>，对于一个正常的waf来说取到<code>file_name.php</code>，发现扩展名为php，接着进行拦截，此处并不讨论waf规则中不含有php关键字等等waf规则本身不完善的情况，我们只有一个目标，那就是waf解析出的filename不出现php关键字，并且后端程序在验证扩展名的时候会认为这是一个php文件。</p>
<p>从各种程序解析的代码来看，为了让waf解析出现问题，干扰的字符除了上文说的引号，空格，转义符，还有<code>:;</code>，这里还是要分为两种形式的测试。</p>
<ul>
<li><p><code>token</code>形式</p>
<p><code>Content-Disposition: form-data; name=key3; filename=file_name:.php</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=file_name&#39;.php</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=file_name&quot;.php</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=file_name\&quot;.php</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=file_name .php</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=file_name;.php</code></p>
<p>前五种情况flask/Java解析结果都是一致的，会取整体作为filename的值，都是含有php关键字的，这也说明如果waf解析存在差异，将特殊字符直接截断取值，会导致waf被绕过。</p>
<p>最后一种情况，flask/Java/php解析都会直接截断，filename=file_name，这样后端获取不了，无论waf解析方式如何，无法绕过。</p>
<p>对于php而言，前三种会如flask以一样，将整体作为filename的值，第五种空格类型，php会截断，最终取filename=file_name，这种容易理解，当没出现引号时，出现空格，即认为参数值结束。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210512165247797.png" alt="image-20210512165247797"></p>
<p>然后再测试转义符号的时候，出现了从<code>\</code>开始截断，并去<code>\</code>后面的值最为filename的值，这种解析方式和boundary解析也不相同，当然双引号和单引号相同效果。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210512165617827.png" alt="image-20210512165617827"></p>
<p>看代码才发现，php并没有把<code>\</code>当作转义符号，而是贴心地将filename看做一个路径，并取路径中文件的名称，毕竟参数名是filename啊:)</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210512171659053.png" alt=""></p>
<p>所以这个解析方式和引号跟本没关系，只是php在解析filename时，会取最后的<code>\</code>或者<code>/</code>后面的值作为<strong>文件名</strong>。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210512174853186.png" alt="image-20210512174853186"></p>
</li>
<li><p><code>quoted string</code>形式</p>
<p><code>Content-Disposition: form-data; name=key3; filename=&quot;file_name:.php&quot;</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=&quot;file_name&#39;.php&quot;</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=&quot;file_name&quot;.php&quot;</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=&quot;file_name\&quot;.php&quot;</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=&quot;file_name .php&quot;</code></p>
<p><code>Content-Disposition: form-data; name=key3; filename=&quot;file_name;.php&quot;</code></p>
<p>flask解析结果还是依照<code>_option_header_piece_re</code>正则，除第三种filename取file_name之外，其他都会取双引号内整体的值作为filename，转义符具有转义作用。php第三种也会解析出file_name，但是在第四种转义符是具有转义作用的，所以进入上文的<code>*php_ap_basename</code>函数时，是没有<code>\</code>的，所以其解析结果也会是<code>file_name&quot;.php</code>，使用单引号的情况和上文<code>引号</code>部分分析一致。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210513111409102.png" alt="image-20210513111409102"></p>
<p>对于Java来说，除第三种情况外，都是会取引号内整体作为filename值，但是第三种情况就非常有趣，上文<code>引号</code>部分已经分析，Java会继续取值，那么最后filename取值为<code>&quot;file_name&quot;.php&quot;</code>。</p>
<p><img src="C:/Users/donky16/Desktop/tmp/http/Markdown/image-20210513152431882.png" alt="image-20210513152431882"></p>
</li>
</ul>
<p>  所以对于Java这个异常的特性来说，通常waf会像php/flask那样在第一次出现闭合双引号时，直接取双引号内内容作为filename的取值，这样就可以绕过文件扩展名的检测。</p>
<h3 id="4-Content-Type-Body"><a href="#4-Content-Type-Body" class="headerlink" title="4. Content-Type(Body)"></a>4. Content-Type(Body)</h3><p><img src="image-20210513153208424.png" alt="image-20210513153208424"> </p>
<p>对于一些不具有编码解析功能的waf，可以通过对参数值的编码绕过waf。</p>
<h4 id="Charset"><a href="#Charset" class="headerlink" title="Charset"></a>Charset</h4><p>对于Java，可以使用UTF-16编码。</p>
<p><img src="image-20210517153729144.png" alt="image-20210517153729144"></p>
<p>flask可以使用UTF-7编码。</p>
<p><img src="image-20210517160156654.png" alt="image-20210517160156654"></p>
<p>由于Java代码中，会把文件和非文件参数都用<code>org.apache.commons.fileupload.FileItem</code>来存储，所以都会进行解码操作，而flask将两者分成了form和files，而且files并没用使用Content-Type中的<code>charset</code>进行解码<code>werkzeug/formparser.py:L564</code>。</p>
<p><img src="image-20210517161242711.png" alt="image-20210517161242711"></p>
<h4 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h4><p><img src="image-20210517164903160.png" alt="image-20210517164903160"> </p>
<p>RFC7578中写了一些其他form-data的解析方式，可以通过<code>_charset_</code>参数指定charset，或者使用<code>encoded-word</code>，但是测试的三种程序都没有做相关的解析，很多只是在邮件中用到。</p>
<h3 id="5-Content-Transfer-Encoding"><a href="#5-Content-Transfer-Encoding" class="headerlink" title="5. Content-Transfer-Encoding"></a>5. Content-Transfer-Encoding</h3><p><img src="image-20210517165215792.png" alt="image-20210517165215792"> </p>
<p>RFC7578明确写出只有三种参数类型可以出现在multipart/form-data中，其他类型<code>MUST</code>被忽略，这里的第三种Content-Transfer-Encoding其实也被废弃。</p>
<p><img src="image-20210517165451682.png" alt="image-20210517165451682"> </p>
<p>然而在flask代码中发现werkzeug实现了此部分。</p>
<p><img src="image-20210517170536557.png" alt="image-20210517170536557"></p>
<p>也可以使用<code>QUOTED-PRINTABLE</code>编码方式。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://github.com/postmanlabs/httpbin" target="_blank" rel="noopener">https://github.com/postmanlabs/httpbin</a></p>
<p><a href="https://www.ietf.org/rfc/rfc1867.txt" target="_blank" rel="noopener">https://www.ietf.org/rfc/rfc1867.txt</a></p>
<p><a href="https://tools.ietf.org/html/rfc7578" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7578</a></p>
<p><a href="https://tools.ietf.org/html/rfc2046#section-5.1" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc2046#section-5.1</a></p>
<p><a href="https://www.php.net/manual/zh/language.variables.external.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/language.variables.external.php</a></p>
<p><a href="https://www.cnblogs.com/youxin/archive/2012/02/13/2348551.html" target="_blank" rel="noopener">https://www.cnblogs.com/youxin/archive/2012/02/13/2348551.html</a></p>
<p><a href="https://xz.aliyun.com/t/9432" target="_blank" rel="noopener">https://xz.aliyun.com/t/9432</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/WAF/" rel="tag"># WAF</a>
          
            <a href="/tags/HTTP/" rel="tag"># HTTP</a>
          
            <a href="/tags/multipart-form-data/" rel="tag"># multipart/form-data</a>
          
            <a href="/tags/RFC/" rel="tag"># RFC</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/02/03/Web缓存投毒cache-attack/" rel="next" title="Web缓存投毒cache attack">
                <i class="fa fa-chevron-left"></i> Web缓存投毒cache attack
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">donky16</p>
              <p class="site-description motion-element" itemprop="description">质性自然，非矫历所得</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景介绍"><span class="nav-number">1.</span> <span class="nav-text">背景介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析环境"><span class="nav-number">2.</span> <span class="nav-text">解析环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基础格式"><span class="nav-number">3.</span> <span class="nav-text">基础格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#详细解析"><span class="nav-number">4.</span> <span class="nav-text">详细解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Content-Type"><span class="nav-number">4.1.</span> <span class="nav-text">1. Content-Type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Boundary"><span class="nav-number">4.2.</span> <span class="nav-text">2. Boundary</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#空格"><span class="nav-number">4.2.1.</span> <span class="nav-text">空格</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#双引号"><span class="nav-number">4.2.2.</span> <span class="nav-text">双引号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#转义符号"><span class="nav-number">4.2.3.</span> <span class="nav-text">转义符号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#空格-amp-双引号"><span class="nav-number">4.2.4.</span> <span class="nav-text">空格 &amp; 双引号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结束分隔行"><span class="nav-number">4.2.5.</span> <span class="nav-text">结束分隔行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他"><span class="nav-number">4.2.6.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Content-Disposition"><span class="nav-number">4.3.</span> <span class="nav-text">3. Content-Disposition</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#空格-1"><span class="nav-number">4.3.1.</span> <span class="nav-text">空格</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重复参数"><span class="nav-number">4.3.2.</span> <span class="nav-text">重复参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#引号"><span class="nav-number">4.3.3.</span> <span class="nav-text">引号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#转义符号-1"><span class="nav-number">4.3.4.</span> <span class="nav-text">转义符号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#文件扩展名"><span class="nav-number">4.3.5.</span> <span class="nav-text">文件扩展名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Content-Type-Body"><span class="nav-number">4.4.</span> <span class="nav-text">4. Content-Type(Body)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Charset"><span class="nav-number">4.4.1.</span> <span class="nav-text">Charset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他-1"><span class="nav-number">4.4.2.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Content-Transfer-Encoding"><span class="nav-number">4.5.</span> <span class="nav-text">5. Content-Transfer-Encoding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考链接"><span class="nav-number">5.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">donky16</span>

  
</div>

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
